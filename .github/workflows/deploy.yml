name: Deploy to AWS EC2

on:
  push:
    branches: [ "main" ]

env:
  # 원격 서버 설정
  REMOTE_DIR: /opt/app
  SERVICE_NAME: myapp

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ✅ gradlew가 있는 디렉터리를 자동으로 찾아 PROJECT_DIR로 설정
      - name: Detect project directory
        shell: bash
        run: |
          set -e
          # 루트에 gradlew가 있으면 .
          if [[ -f "./gradlew" ]]; then
            DIR="."
          else
            # 리포지토리 내에서 gradlew가 들어있는 디렉터리 검색
            FOUND=$(git ls-files | grep -E '(^|/)(gradlew)$' || true)
            if [[ -z "$FOUND" ]]; then
              echo "gradlew not found. Is this a Gradle project?"; exit 1
            fi
            # 가장 첫 후보의 상위 디렉터리 사용
            DIR=$(dirname "$(echo "$FOUND" | head -n1)")
          fi
          echo "PROJECT_DIR=$DIR" >> $GITHUB_ENV
          echo "Detected PROJECT_DIR=$DIR"
          ls -la "$DIR"

      - name: Set up JDK 21 (Temurin) + Gradle cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Build (Gradle bootJar)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test
          ls -lh build/libs/

      - name: Prepare remote dir (AL2023 over SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}         # 15.165.170.13
          username: ${{ secrets.EC2_USER }}     # ec2-user
          key: ${{ secrets.EC2_PRIVATE_KEY }}   # pem 내용 전체
          script: |
            sudo mkdir -p ${{ env.REMOTE_DIR }}/upload
            sudo rm -f ${{ env.REMOTE_DIR }}/upload/*.jar

      - name: Upload JAR to EC2 (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "${{ env.PROJECT_DIR }}/build/libs/*.jar"
          target: "${{ env.REMOTE_DIR }}/upload"

      - name: Move & restart service (systemd on AL2023)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            JAR_PATH=$(ls -t ${{ env.REMOTE_DIR }}/upload/*.jar | head -n 1)
            echo "Using JAR: ${JAR_PATH}"
            sudo mv "${JAR_PATH}" ${{ env.REMOTE_DIR }}/app.jar
            sudo chown ec2-user:ec2-user ${{ env.REMOTE_DIR }}/app.jar
            sudo systemctl daemon-reload
            sudo systemctl restart ${{ env.SERVICE_NAME }}
            sleep 3
            sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -n 20
            curl -sI http://127.0.0.1:8080/ | head -n 1 || true
