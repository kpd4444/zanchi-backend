<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>검색 · 클립</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { color-scheme: dark light; }
        * { box-sizing: border-box; }
        body { margin:0; font-family:-apple-system, system-ui, Segoe UI, Roboto, "Noto Sans KR", sans-serif; background:#0b0b0b; color:#f2f2f2; }
        header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(8px); background:rgba(0,0,0,.6); border-bottom:1px solid rgba(255,255,255,.08); }
        header .bar { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; max-width:860px; margin:0 auto; }
        .btn { padding:8px 12px; border:1px solid #2a2a2a; background:#1a1a1a; color:#fff; border-radius:10px; font-size:13px; cursor:pointer; }

        .wrap { max-width:860px; margin:0 auto; padding:12px 14px; }
        .search { display:flex; gap:8px; align-items:center; }
        .search input { flex:1; padding:10px 12px; border-radius:12px; background:#141414; border:1px solid #2a2a2a; color:#fff; outline:none; }
        .tabs { display:flex; gap:18px; padding:12px 2px 8px; border-bottom:1px solid #1b1b1b; margin-top:8px; }
        .tab { padding:8px 2px; cursor:pointer; opacity:.8 }
        .tab.active { font-weight:800; border-bottom:2px solid #8b5cf6; opacity:1 }

        .grid { padding:14px 2px 28px; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
        .card { background:#111; border:1px solid #222; border-radius:12px; overflow:hidden; }
        .thumb { width:100%; aspect-ratio:9/16; background:#000; object-fit:cover; display:block; }
        .meta { display:flex; align-items:center; gap:8px; padding:8px 10px; }
        .av { width:28px; height:28px; border-radius:50%; background:#333; object-fit:cover; flex:0 0 auto; }
        .who { font-size:13px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .id { font-size:12px; color:#bdbdbd; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .cap { padding:8px 10px; font-size:13px; color:#e9e9e9; border-top:1px solid #1b1b1b; min-height:38px; }
        .row { display:flex; align-items:center; gap:8px; padding:8px 10px; color:#bdbdbd; border-top:1px solid #1b1b1b; font-size:12px; }
        .loadmore { display:block; margin:8px auto 24px; }

        .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:#222; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #333; font-size:13px; z-index:9999; display:none; }

        @media (prefers-color-scheme: light) {
            body { background:#f7f7f8; color:#111; }
            header { background:rgba(255,255,255,.7); border-color:rgba(0,0,0,.06); }
            .card { background:#fff; border-color:#ececec; }
            .cap, .row { border-color:#eee; }
            .btn { background:#fafafa; color:#111; border-color:#eaeaea; }
            .search input { background:#fff; color:#111; border-color:#eaeaea; }
        }
    </style>
</head>
<body>
<header>
    <div class="bar">
        <div style="font-weight:800">검색</div>
        <button class="btn" onclick="history.back()">닫기</button>
    </div>
</header>

<main class="wrap">
    <div class="search">
        <input id="q" type="search" placeholder="검색어를 입력하세요 (예: 노래, 사용자명…)" />
        <button id="clear" class="btn">지우기</button>
    </div>

    <nav class="tabs">
        <div id="tab-people" class="tab">계정</div>
        <div id="tab-clips" class="tab active">클립</div>
    </nav>

    <section id="grid" class="grid"></section>
    <button id="more" class="btn loadmore" style="display:none">더 불러오기</button>
</main>

<div id="toast" class="toast"></div>

<script>
    // ==== utils ====
    const $ = sel => document.querySelector(sel);
    const QP = new URLSearchParams(location.search);
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1200); }
    function getToken(){ const t=localStorage.getItem('jwt')||localStorage.getItem('token'); if(!t) return null; return t.startsWith('Bearer ')?t:`Bearer ${t}`; }
    async function getJson(url, opt={}){
        const headers = opt.headers ? {...opt.headers} : {};
        const hasBody = opt.body !== undefined && opt.body !== null;
        const isForm = typeof FormData!=='undefined' && opt.body instanceof FormData;
        if(!headers['Content-Type'] && opt.method && opt.method!=='GET' && hasBody && !isForm) headers['Content-Type']='application/json';
        const tk=getToken(); if(tk) headers['Authorization']=tk;
        const res = await fetch(url, {...opt, headers});
        if(!res.ok){ throw new Error(await res.text().catch(()=>'')); }
        if(res.status===204) return null;
        const ct = res.headers.get('Content-Type')||'';
        return ct.includes('application/json') ? res.json() : res.text().catch(()=>null);
    }
    const pickPage = (x)=> Array.isArray(x)?x : (x && Array.isArray(x.content)? x.content : []);
    const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56"><rect width="100%" height="100%" fill="#334155"/><circle cx="28" cy="20" r="12" fill="#94a3b8"/><rect x="10" y="35" width="36" height="14" rx="7" fill="#94a3b8"/></svg>`);

    // ==== state ====
    const state = {
        q: QP.get('q') || '',
        page: 0,
        size: 20,
        totalPages: 1,
        loading: false,
        useServerSearch: true  // 서버 검색 시도, 실패하면 클라이언트 필터 폴백
    };

    // ==== tabs ====
    $('#tab-people').addEventListener('click', ()=>{
        const q = $('#q').value.trim();
        location.href = `/search-people.html?q=${encodeURIComponent(q)}`;
    });
    $('#tab-clips').classList.add('active');

    // ==== search box ====
    $('#q').value = state.q;
    $('#clear').addEventListener('click', ()=>{
        $('#q').value=''; state.q=''; state.page=0; $('#grid').innerHTML=''; search();
    });
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    const onInput = debounce(()=>{
        state.q = $('#q').value.trim();
        state.page = 0;
        $('#grid').innerHTML='';
        history.replaceState(null,'',`?q=${encodeURIComponent(state.q)}`);
        search();
    }, 250);
    $('#q').addEventListener('input', onInput);

    // ==== render ====
    function card(clip){
        const el = document.createElement('article');
        el.className = 'card';

        const v = document.createElement('video');
        v.className = 'thumb';
        v.muted = true; v.playsInline = true; v.preload = 'metadata';
        v.src = clip.videoUrl || '';
        el.appendChild(v);

        const cap = document.createElement('div');
        cap.className = 'cap';
        cap.textContent = clip.caption || '';
        el.appendChild(cap);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const av = document.createElement('img');
        av.className = 'av';
        av.src = clip.uploaderAvatarUrl || DEFAULT_AVATAR;
        av.onerror = ()=> av.src = DEFAULT_AVATAR;

        const whoWrap = document.createElement('div');
        whoWrap.style.minWidth='0';
        const who = document.createElement('div');
        who.className = 'who';
        who.textContent = clip.authorName || clip.uploaderName || clip.memberName || '작성자';
        who.style.cursor='pointer';
        who.addEventListener('click', ()=>{
            const uid = clip.uploaderId ?? clip.memberId ?? clip.authorId;
            if(uid!=null) location.href = `/user.html?userId=${encodeURIComponent(uid)}`;
        });
        const id = document.createElement('div');
        id.className = 'id';
        id.textContent = clip.uploaderLoginId ? '@'+clip.uploaderLoginId : '';
        whoWrap.appendChild(who); whoWrap.appendChild(id);

        meta.appendChild(av); meta.appendChild(whoWrap);
        el.appendChild(meta);

        const row = document.createElement('div');
        row.className = 'row';
        row.textContent = `조회수 ${clip.viewCount ?? 0} · 좋아요 ${clip.likeCount ?? (Array.isArray(clip.likes)?clip.likes.length:0)}`;
        el.appendChild(row);

        return el;
    }

    function render(items, append){
        const grid = $('#grid');
        const frag = document.createDocumentFragment();
        items.forEach(c => frag.appendChild(card(c)));
        if(append) grid.appendChild(frag); else { grid.innerHTML=''; grid.appendChild(frag); }
    }

    // ==== search ====
    async function search(){
        if(state.loading) return;
        state.loading = true;
        $('#more').style.display = 'none';
        try{
            let data, items, totalPages;

            if(state.useServerSearch){
                try {
                    const url = `/api/clips/search?q=${encodeURIComponent(state.q)}&page=${state.page}&size=${state.size}`;
                    data = await getJson(url);
                    items = pickPage(data);
                    totalPages = data?.totalPages ?? 1;
                } catch {
                    state.useServerSearch = false;
                }
            }

            if(!state.useServerSearch){
                // 폴백: 피드 받아서 프론트 필터
                const feed = await getJson(`/api/clips/feed?page=${state.page}&size=${state.size}`);
                const list = pickPage(feed);
                const q = state.q.toLowerCase();
                items = q
                    ? list.filter(c=>{
                        const caption = (c.caption||'').toLowerCase();
                        const name = (c.authorName||c.uploaderName||c.memberName||'').toLowerCase();
                        const login = (c.uploaderLoginId||c.loginId||'').toLowerCase();
                        return caption.includes(q) || name.includes(q) || login.includes(q);
                    })
                    : list;
                totalPages = feed?.totalPages ?? 1;
            }

            render(items, state.page>0);
            state.totalPages = totalPages;

            if(state.page + 1 < state.totalPages) $('#more').style.display='block';
        } catch(e){
            console.error(e); toast('검색 실패');
        } finally {
            state.loading = false;
        }
    }

    $('#more').addEventListener('click', ()=>{
        if(state.page + 1 < state.totalPages){
            state.page += 1;
            search();
        }
    });

    // boot
    (async function(){
        await search();
        $('#q').focus();
    })();
</script>
</body>
</html>