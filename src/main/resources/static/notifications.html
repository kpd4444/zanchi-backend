<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Notifications Test</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
        .toolbar { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
        #badge { display:none; align-items:center; justify-content:center; width:24px; height:24px; border-radius:999px; background:#ef4444; color:#fff; font-weight:700; font-size:12px; }
        #dropdown { border:1px solid #e5e7eb; border-radius:8px; width:720px; max-width:100%; display:none; }
        #dropdown.open { display:block; }
        .head { display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #e5e7eb; background:#f8fafc; }
        .list { max-height:520px; overflow:auto; padding:8px 12px; }
        .item { display:flex; gap:10px; padding:10px; border-bottom:1px solid #f1f5f9; }
        .item.unread { background:#fff7ed; }
        .meta { color:#6b7280; font-size:12px; margin-top:2px; }
        .empty { padding:36px; color:#6b7280; text-align:center; }
        .pager { display:flex; gap:8px; padding:10px; justify-content:center; border-top:1px solid #e5e7eb; }
        button { padding:6px 10px; border:1px solid #cbd5e1; background:#fff; border-radius:6px; cursor:pointer; }
        button:hover { background:#f8fafc; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#334155; }
    </style>
</head>
<body>
<h2>Notifications Test 🔔</h2>
<p class="mono" id="state">ETag: -</p>

<div class="toolbar">
    <button id="bell">토글</button>
    <span id="badge">0</span>
    <button id="btn-refresh">목록 새로고침</button>
    <button id="btn-read-all">모두 읽음 처리</button>
</div>

<div id="dropdown">
    <div class="head">
        <div class="mono" id="page-info">페이지 1 / 1</div>
        <div style="display:flex; gap:6px;">
            <button id="prev">이전</button>
            <button id="next">다음</button>
        </div>
    </div>
    <div class="list" id="list"></div>
    <div class="pager">
        <button id="prev2">이전</button>
        <button id="next2">다음</button>
    </div>
</div>

<script>
    // ===== API 경로 =====
    const API = {
        meSummary: '/api/me/summary',                 // 현재 사용자 요약(id 포함)
        unread: '/api/notifications/unread-count',    // 미읽음 개수
        list:   '/api/notifications',                 // 목록
        read:   (id) => `/api/notifications/${id}/read`,
        readAll:'/api/notifications/read-all'
    };
    const POLL_MS = 30000; // 30초 폴링

    // ===== 상태 =====
    let USER_ID = 'unknown';
    let ETAG_KEY = 'notif-etag:unknown';
    let etag = '';
    let page = 0, size = 20, totalPages = 1;

    // ===== 유틸 =====
    function $(sel){ return document.querySelector(sel); }
    function fmtTime(iso) {
        try {
            const d = new Date(iso);
            const diff = (Date.now() - d.getTime()) / 1000;
            if (diff < 60) return `${Math.floor(diff)}초 전`;
            if (diff < 3600) return `${Math.floor(diff/60)}분 전`;
            if (diff < 86400) return `${Math.floor(diff/3600)}시간 전`;
            return `${Math.floor(diff/86400)}일 전`;
        } catch { return iso; }
    }
    function setBadge(n) {
        const b = $('#badge');
        if (!n) { b.style.display='none'; b.textContent='0'; }
        else { b.style.display='flex'; b.textContent = n > 99 ? '99+' : String(n); }
    }
    function setStateTag(tag) {
        if (tag) {
            etag = tag;
            localStorage.setItem(ETAG_KEY, etag);
        }
        $('#state').textContent = `ETag: ${etag} (user:${USER_ID})`;
    }
    function setUserScope(userId) {
        USER_ID = String(userId ?? 'unknown');
        ETAG_KEY = `notif-etag:${USER_ID}`;
        etag = localStorage.getItem(ETAG_KEY) || '';
        $('#state').textContent = `ETag: ${etag} (user:${USER_ID})`;
    }

    // ===== 현재 사용자 조회 =====
    async function fetchMe() {
        try {
            const res = await fetch(API.meSummary, { credentials:'include', cache:'no-store' });
            if (!res.ok) throw new Error('me summary failed');
            const me = await res.json();   // MemberSummary DTO (id 포함)
            return me?.id ?? 'unknown';
        } catch {
            return 'unknown';
        }
    }

    // ===== API =====
    async function fetchUnread() {
        const headers = etag ? { 'If-None-Match': etag } : {};
        const res = await fetch(API.unread, {
            credentials:'include',
            cache:'no-store',
            headers
        });
        if (res.status === 304) return;
        setStateTag(res.headers.get('ETag'));
        if (!res.ok) throw new Error('unread failed: ' + res.status);
        const n = await res.json();
        setBadge(n);
    }

    async function fetchList() {
        const headers = etag ? { 'If-None-Match': etag } : {};
        const url = `${API.list}?page=${page}&size=${size}`;
        const res = await fetch(url, {
            credentials:'include',
            cache:'no-store',
            headers
        });
        if (res.status !== 304) setStateTag(res.headers.get('ETag'));
        if (res.status === 304) return;
        if (!res.ok) throw new Error('list failed: ' + res.status);
        const data = await res.json(); // Spring Page
        totalPages = data.totalPages ?? 1;
        $('#page-info').textContent = `페이지 ${data.number+1} / ${totalPages}`;
        renderList(data.content || []);
    }

    async function markRead(id) {
        const res = await fetch(API.read(id), {
            method:'PATCH',
            credentials:'include',
            cache:'no-store'
        });
        if (!res.ok) throw new Error('markRead failed');
        await fetchUnread();
        await fetchList();
    }

    async function markAllRead() {
        const res = await fetch(API.readAll, {
            method:'PATCH',
            credentials:'include',
            cache:'no-store'
        });
        if (!res.ok) throw new Error('readAll failed');
        await fetchUnread();
        await fetchList();
    }

    // ===== 렌더링 =====
    function renderList(items) {
        const host = $('#list');
        if (!items.length) { host.innerHTML = `<div class="empty">알림이 없습니다.</div>`; return; }
        host.innerHTML = items.map(n => `
        <div class="item ${n.read ? '' : 'unread'}">
          <div style="width:32px;height:32px;border-radius:50%;background:#e2e8f0;overflow:hidden;flex:0 0 32px;">
            ${n.actorAvatarUrl ? `<img src="${n.actorAvatarUrl}" style="width:100%;height:100%;object-fit:cover;" alt="">` : ''}
          </div>
          <div style="flex:1;">
            <div>${n.text}</div>
            <div class="meta">
              ${n.actorNickname ? n.actorNickname + ' · ' : ''}${fmtTime(n.createdAt)}
              ${n.clipId ? ` · clipId=${n.clipId}` : ''} ${n.commentId ? ` · commentId=${n.commentId}` : ''}
              ${n.type ? ` · type=${n.type}` : ''}
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            ${n.read ? '' : `<button data-read="${n.id}">읽음</button>`}
          </div>
        </div>
      `).join('');

        host.querySelectorAll('button[data-read]').forEach(btn => {
            btn.addEventListener('click', e => {
                const id = e.currentTarget.getAttribute('data-read');
                markRead(id).catch(console.error);
            });
        });
    }

    // ===== UI 이벤트 =====
    $('#bell').addEventListener('click', async () => {
        const dd = $('#dropdown');
        dd.classList.toggle('open');
        if (dd.classList.contains('open')) {
            await fetchList().catch(console.error);
        }
    });
    $('#btn-refresh').addEventListener('click', () => fetchList().catch(console.error));
    $('#btn-read-all').addEventListener('click', () => markAllRead().catch(console.error));
    $('#prev').addEventListener('click', () => { if (page > 0) { page--; fetchList().catch(console.error); }});
    $('#next').addEventListener('click', () => { if (page+1 < totalPages) { page++; fetchList().catch(console.error); }});
    $('#prev2').addEventListener('click', () => { if (page > 0) { page--; fetchList().catch(console.error); }});
    $('#next2').addEventListener('click', () => { if (page+1 < totalPages) { page++; fetchList().catch(console.error); }});

    // ===== 초기화 =====
    (async function init(){
        const uid = await fetchMe();  // /api/me/summary → { id, ... }
        setUserScope(uid);

        await fetchUnread().catch(console.error);
        setInterval(() => fetchUnread().catch(console.error), POLL_MS);
    })();
</script>
</body>
</html>
