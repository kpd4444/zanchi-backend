<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI · Kakao Places 테스트</title>
    <style>
        :root { color-scheme: dark light; }
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:#0b0b0b;color:#f2f2f2}
        header{position:sticky;top:0;background:rgba(0,0,0,.6);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
        .wrap{max-width:980px;margin:0 auto;padding:16px}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .card{background:#121212;border:1px solid #222;border-radius:14px;padding:14px;flex:1 1 320px;min-width:320px}
        .title{font-weight:800;margin-bottom:10px}
        label{font-size:13px;color:#bdbdbd}
        input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#141414;color:#fff;outline:none}
        textarea{min-height:100px}
        .btn{padding:10px 14px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff;border-radius:10px;cursor:pointer}
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
        .place{border:1px solid #2a2a2a;border-radius:12px;padding:10px}
        .muted{color:#a0a0a0;font-size:12px}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#222;border:1px solid #333;color:#fff;padding:8px 12px;border-radius:10px;z-index:9999}
        .badge{display:inline-block;padding:3px 8px;border:1px solid #333;border-radius:999px;font-size:11px;color:#ddd;margin-left:8px}
        @media (prefers-color-scheme: light){
            body{background:#f7f7f8;color:#111}
            header{background:rgba(255,255,255,.75);border-color:rgba(0,0,0,.06)}
            .card{background:#fff;border-color:#e9e9e9}
            input,select,textarea{background:#fff;color:#111;border-color:#e9e9e9}
            .btn{background:#fafafa;color:#111;border-color:#e9e9e9}
            .place{border-color:#e9e9e9}
            .toast{background:#111;color:#fff}
        }
    </style>
</head>
<body>
<header>
    <div class="wrap row" style="align-items:center;justify-content:space-between">
        <div style="font-weight:900;letter-spacing:.2px">AI · Kakao Places 테스트</div>
        <div class="muted">F2: 토큰 입력 / 저장</div>
    </div>
</header>

<main class="wrap">
    <section class="row">
        <!-- LLM ASK -->
        <div class="card">
            <div class="title">LLM 질문 (/api/ai/ask)</div>
            <label>질문</label>
            <textarea id="askInput" placeholder="예) 송도 근처 데이트 코스 아이디어 3개만"></textarea>
            <div class="row" style="margin-top:10px">
                <button class="btn" id="askBtn">질문 보내기</button>
                <button class="btn" id="clearAsk">지우기</button>
            </div>
            <div style="margin-top:10px">
                <label>응답</label>
                <pre id="askOut" style="white-space:pre-wrap;background:transparent;border:0;margin:6px 0 0"></pre>
            </div>
        </div>

        <!-- PLACES -->
        <div class="card">
            <div class="title">장소 검색 (/api/ai/places)</div>
            <div class="grid2">
                <div>
                    <label>장소(키워드)</label>
                    <input id="pLocation" placeholder="예) 송도센트럴파크, 인천 송도 트리플스트리트" />
                </div>
                <div>
                    <label>반경(m)</label>
                    <input id="pRadius" type="number" value="1200" />
                </div>
            </div>
            <div class="grid2" style="margin-top:8px">
                <div>
                    <label>카테고리</label>
                    <select id="pCategory">
                        <option value="FD6">FD6 · 음식점</option>
                        <option value="CE7">CE7 · 카페</option>
                        <option value="AT4">AT4 · 관광명소</option>
                        <option value="CS2">CS2 · 편의점</option>
                        <option value="BK9">BK9 · 은행</option>
                    </select>
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button class="btn" id="pSearch" style="width:100%">검색</button>
                </div>
            </div>

            <div style="margin-top:10px">
                <div class="muted">결과</div>
                <div id="placesList" class="list"></div>
            </div>
        </div>
    </section>

    <!-- DATE COURSE -->
    <section class="card" style="margin-top:14px">
        <div class="title">데이트코스 번들 (/api/ai/datecourse)</div>
        <div class="grid2">
            <div>
                <label>장소(키워드)</label>
                <input id="dLocation" placeholder="예) 송도센트럴파크" />
            </div>
            <div>
                <label>반경(m)</label>
                <input id="dRadius" type="number" value="1200" />
            </div>
        </div>
        <div class="row" style="margin-top:8px">
            <button class="btn" id="dSearch">음식점+카페 검색</button>
            <span class="muted" id="centerOut"></span>
        </div>
        <div class="row" style="margin-top:10px">
            <div style="flex:1 1 320px;min-width:320px">
                <div style="font-weight:700">음식점 <span class="badge">FD6</span></div>
                <div id="dRestaurants" class="list"></div>
            </div>
            <div style="flex:1 1 320px;min-width:320px">
                <div style="font-weight:700">카페 <span class="badge">CE7</span></div>
                <div id="dCafes" class="list"></div>
            </div>
        </div>
    </section>
</main>

<script>
    /* ===== Auth helpers ===== */
    function getAuthHeader() {
        let t = localStorage.getItem('token') || localStorage.getItem('jwt');
        if (!t) return null;
        t = t.startsWith('Bearer ') ? t : `Bearer ${t}`;
        localStorage.setItem('token', t);
        localStorage.removeItem('jwt');
        return t;
    }

    // F2 → 토큰 수동 입력
    window.addEventListener('keydown', (e) => {
        if (e.key === 'F2') {
            const cur = (localStorage.getItem('token') || localStorage.getItem('jwt') || '').replace(/^Bearer\s+/, '');
            const v = prompt('JWT를 입력하세요 (Bearer 제외, token으로 저장)', cur);
            if (v !== null) {
                localStorage.setItem('token', `Bearer ${v.trim()}`);
                localStorage.removeItem('jwt');
                toast('토큰 저장 완료');
            }
        }
    });

    /* ===== HTTP helper ===== */
    async function getJson(url, opt = {}) {
        const headers = opt.headers ? { ...opt.headers } : {};
        if (!headers['Content-Type'] && opt.method && opt.method !== 'GET') {
            headers['Content-Type'] = 'application/json';
        }
        const auth = getAuthHeader();
        if (auth) headers['Authorization'] = auth;

        const res = await fetch(url, { ...opt, headers });
        const ct = res.headers.get('Content-Type') || '';
        const bodyText = await res.text();
        const body = ct.includes('application/json') ? (bodyText ? JSON.parse(bodyText) : null) : bodyText;

        if (!res.ok) {
            const msg = (body && body.error) ? JSON.stringify(body) : (bodyText || `HTTP ${res.status}`);
            throw new Error(msg);
        }
        return body;
    }

    function toast(msg, ms = 1400) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), ms);
    }

    function el(tag, attrs = {}, children = []) {
        const e = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
            if (k === 'class') e.className = v;
            else if (k === 'text') e.textContent = v;
            else if (k === 'html') e.innerHTML = v;
            else e.setAttribute(k, v);
        }
        (Array.isArray(children) ? children : [children]).forEach(c => c && e.appendChild(c));
        return e;
    }

    function placeRow(p) {
        const title = el('div', { style: 'font-weight:700' }, [
            el('a', { href: p.url || '#', target: '_blank', rel: 'noopener', text: p.name || '(이름 없음)' })
        ]);
        const addr = el('div', { class: 'muted', text: p.address || (p.phone ? p.phone : '') });
        const meta = el('div', { class: 'muted' },
            `(${p.category || ''})  lat:${p.lat?.toFixed?.(6)}  lng:${p.lng?.toFixed?.(6)}${p.distance ? ' · ' + p.distance + 'm' : ''}`
        );

        const actions = el('div', { class: 'row', style: 'margin-top:6px' }, [
            el('a', {
                class: 'btn',
                href: `https://maps.google.com/?q=${p.lat},${p.lng}`,
                target: '_blank',
                rel: 'noopener',
                text: '구글맵'
            }),
            el('a', {
                class: 'btn',
                href: p.url || '#',
                target: '_blank',
                rel: 'noopener',
                text: '카카오 상세'
            })
        ]);

        return el('div', { class: 'place' }, [title, addr, meta, actions]);
    }

    /* ====== LLM ASK ====== */
    document.getElementById('askBtn').addEventListener('click', async () => {
        const q = document.getElementById('askInput').value.trim();
        if (!q) return toast('질문을 입력하세요');
        const out = document.getElementById('askOut');
        out.textContent = '요청 중...';
        try {
            const text = await getJson(`/api/ai/ask?q=${encodeURIComponent(q)}`);
            out.textContent = typeof text === 'string' ? text : JSON.stringify(text, null, 2);
        } catch (e) {
            out.textContent = e.message || '에러';
            if ((e.message || '').toUpperCase().includes('UNAUTHORIZED')) toast('로그인이 필요합니다.');
        }
    });
    document.getElementById('clearAsk').addEventListener('click', () => {
        document.getElementById('askInput').value = '';
        document.getElementById('askOut').textContent = '';
    });

    /* ====== Places ====== */
    document.getElementById('pSearch').addEventListener('click', async () => {
        const location = document.getElementById('pLocation').value.trim();
        const category = document.getElementById('pCategory').value;
        const radius = Number(document.getElementById('pRadius').value || 1200);
        const box = document.getElementById('placesList');
        box.innerHTML = '<div class="muted">불러오는 중...</div>';
        try {
            const list = await getJson(`/api/ai/places?location=${encodeURIComponent(location)}&category=${encodeURIComponent(category)}&radius=${radius}`);
            box.innerHTML = '';
            (Array.isArray(list) ? list : []).forEach(p => box.appendChild(placeRow(p)));
            if (!list || list.length === 0) box.innerHTML = '<div class="muted">결과 없음</div>';
        } catch (e) {
            console.error(e);
            box.innerHTML = `<div class="muted">오류: ${e.message}</div>`;
            if ((e.message || '').toUpperCase().includes('UNAUTHORIZED')) toast('로그인이 필요합니다.');
        }
    });

    /* ====== Date Course bundle ====== */
    document.getElementById('dSearch').addEventListener('click', async () => {
        const location = document.getElementById('dLocation').value.trim();
        const radius = Number(document.getElementById('dRadius').value || 1200);
        const restaurantsBox = document.getElementById('dRestaurants');
        const cafesBox = document.getElementById('dCafes');
        const centerOut = document.getElementById('centerOut');

        restaurantsBox.innerHTML = '<div class="muted">불러오는 중...</div>';
        cafesBox.innerHTML = '<div class="muted">불러오는 중...</div>';
        centerOut.textContent = '';

        try {
            const data = await getJson(`/api/ai/datecourse?location=${encodeURIComponent(location)}&radius=${radius}`);
            const restaurants = Array.isArray(data?.restaurants) ? data.restaurants : [];
            const cafes = Array.isArray(data?.cafes) ? data.cafes : [];
            const c = data?.center;
            if (c && typeof c.lat === 'number' && typeof c.lng === 'number') {
                centerOut.textContent = `중심: lat ${c.lat.toFixed(6)}, lng ${c.lng.toFixed(6)}`;
            }

            restaurantsBox.innerHTML = '';
            cafesBox.innerHTML = '';
            restaurants.forEach(p => restaurantsBox.appendChild(placeRow(p)));
            cafes.forEach(p => cafesBox.appendChild(placeRow(p)));
            if (restaurants.length === 0) restaurantsBox.innerHTML = '<div class="muted">결과 없음</div>';
            if (cafes.length === 0) cafesBox.innerHTML = '<div class="muted">결과 없음</div>';
        } catch (e) {
            console.error(e);
            restaurantsBox.innerHTML = `<div class="muted">오류: ${e.message}</div>`;
            cafesBox.innerHTML = `<div class="muted">오류: ${e.message}</div>`;
            if ((e.message || '').toUpperCase().includes('UNAUTHORIZED')) toast('로그인이 필요합니다.');
        }
    });

    // 초깃값 샘플
    document.getElementById('pLocation').value = '송도센트럴파크';
    document.getElementById('dLocation').value = '송도센트럴파크';
</script>
</body>
</html>
