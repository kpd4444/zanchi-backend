<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ë§ˆì´í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{color-scheme:dark light}
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:#0b0b0b;color:#f2f2f2}
        .wrap{max-width:760px;margin:0 auto}
        header{position:sticky;top:0;z-index:5;background:rgba(0,0,0,.6);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid rgba(255,255,255,.08)}
        header .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
        .title{font-weight:800}
        .profile{padding:16px}
        .top{display:flex;gap:16px;align-items:center}
        .avatar{width:80px;height:80px;border-radius:50%;background:#333;flex:0 0 auto;object-fit:cover}
        .name{font-weight:800;font-size:18px}
        .meta{display:flex;gap:18px;margin:10px 0}
        .meta .n{font-weight:800}
        .meta .linklike{cursor:pointer;opacity:.85}
        .meta .linklike:hover{opacity:1;text-decoration:underline}
        .btns{display:flex;gap:10px;margin-top:8px}
        .btn{padding:8px 12px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff;border-radius:10px;font-size:13px;cursor:pointer}
        .tabs{display:flex;gap:16px;border-bottom:1px solid #1b1b1b;padding:0 16px}
        .tab{padding:12px 2px;cursor:pointer}
        .tab.active{font-weight:800;border-bottom:2px solid #8b5cf6}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;padding:16px}
        .card{background:#111;border:1px solid #222;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
        .thumb{width:100%;aspect-ratio:16/9;background:#000;object-fit:cover}
        .cap{padding:10px 12px;font-size:14px}
        .row{display:flex;gap:8px;align-items:center;padding:10px 12px;margin-top:auto;border-top:1px solid #1b1b1b}
        .ghost{opacity:.6}
        .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#222;color:#fff;padding:10px 14px;border-radius:10px;border:1px solid #333;font-size:13px;z-index:9999}
        input[type=file]{display:none}

        /* ===== íŒ”ë¡œìš° ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬(í•˜ë‹¨ ì‹œíŠ¸) ===== */
        .dim{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:.2s;z-index:30}
        .dim.show{opacity:1;pointer-events:auto}
        .sheet{position:fixed;left:50%;transform:translateX(-50%) translateY(100%);bottom:0;width:min(760px,100vw);max-height:72vh;background:#111;border:1px solid #222;border-radius:16px 16px 0 0;box-shadow:0 -10px 24px rgba(0,0,0,.35);transition:.25s;z-index:31;display:flex;flex-direction:column}
        .sheet.show{transform:translateX(-50%) translateY(0)}
        .sheet .head{display:flex;align-items:center;gap:8px;padding:12px 14px;border-bottom:1px solid #1b1b1b}
        .sheet .title{font-weight:800}
        .sheet .list{overflow:auto;padding:6px 10px 12px}
        .person{display:flex;align-items:center;gap:10px;padding:8px 6px;border-radius:10px}
        .person:hover{background:#151515}
        .pav{width:40px;height:40px;border-radius:50%;background:#333;flex:0 0 auto;object-fit:cover}
        .pname{font-weight:700}
        .pright{margin-left:auto;display:flex;gap:6px}
        .loadmore{margin:8px auto 14px}
        @media (prefers-color-scheme:light){
            body{background:#f7f7f8;color:#111}
            header{background:rgba(255,255,255,.7);border-color:rgba(0,0,0,.06)}
            .card{background:#fff;border-color:#ececec}
            .row{border-color:#eee}
            .btn{background:#fafafa;color:#111;border-color:#eaeaea}
            .sheet{background:#fff;border-color:#eaeaea}
            .person:hover{background:#f7f7f8}
        }
    </style>
</head>
<body>
<header>
    <div class="bar wrap">
        <div class="title">ë§ˆì´í˜ì´ì§€</div>
        <button id="refreshBtn" class="btn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
</header>

<main class="wrap">
    <section class="profile">
        <div class="top">
            <img id="avatar" class="avatar" alt="avatar">
            <div>
                <div id="displayName" class="name">-</div>
                <div class="meta">
                    <div><span class="n" id="postCount">0</span> ê²Œì‹œë¬¼</div>
                    <div class="linklike" id="followersOpen"><span class="n" id="followerCount">0</span> íŒ”ë¡œì›Œ</div>
                    <div class="linklike" id="followingOpen"><span class="n" id="followingCount">0</span> íŒ”ë¡œì‰</div>
                </div>
                <div class="btns">
                    <label class="btn" for="avatarInput">í”„ë¡œí•„ í¸ì§‘(ì•„ë°”íƒ€)</label>
                    <button class="btn" id="shareBtn">í”„ë¡œí•„ ê³µìœ </button>
                </div>
            </div>
        </div>
        <input id="avatarInput" type="file" accept="image/*">
    </section>

    <nav class="tabs">
        <div class="tab active" data-tab="mine">í´ë¦½</div>
        <div class="tab" data-tab="saved">ì €ì¥í•œ í´ë¦½</div>
    </nav>

    <section id="mine" class="grid"></section>
    <section id="saved" class="grid" style="display:none"></section>
</main>

<!-- ===== íŒ”ë¡œìš° ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ ===== -->
<div class="dim" id="dim"></div>
<section class="sheet" id="followSheet" aria-hidden="true">
    <div class="head">
        <div class="title" id="sheetTitle">íŒ”ë¡œì›Œ</div>
        <div style="margin-left:auto"></div>
        <button class="btn" id="sheetClose">ë‹«ê¸°</button>
    </div>
    <div class="list" id="followList"></div>
    <button class="btn loadmore" id="sheetMore" style="display:none">ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
</section>

<div class="toast" id="toast" style="display:none"></div>

<script>
    // ===== ê¸°ë³¸ ì•„ë°”íƒ€ (ë‚´ì¥ SVG, ë„¤íŠ¸ì›Œí¬ 404 ì—†ìŒ) =====
    const DEFAULT_AVATAR_DATA =
        'data:image/svg+xml;utf8,' +
        encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160">
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#4b5563"/><stop offset="1" stop-color="#1f2937"/>
      </linearGradient></defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <circle cx="80" cy="60" r="32" fill="#9ca3af"/>
      <rect x="28" y="100" width="104" height="44" rx="22" fill="#9ca3af"/>
    </svg>`);

    function applyAvatar(url, imgEl){
        const img = imgEl || document.getElementById('avatar');
        img.onerror = null;
        if (!url) { img.src = DEFAULT_AVATAR_DATA; return; }
        img.onerror = () => { img.onerror = null; img.src = DEFAULT_AVATAR_DATA; };
        img.src = url;
    }

    // ===== token =====
    function getToken(){
        const t = localStorage.getItem('jwt') || localStorage.getItem('token');
        if (!t) return null;
        return t.startsWith('Bearer ') ? t : `Bearer ${t}`;
    }

    // ===== helpers =====
    const $ = s => document.querySelector(s);
    function toast(msg){
        const t = $('#toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(()=> t.style.display = 'none', 1500);
    }
    function pickPage(x){ return Array.isArray(x)?x : (x && Array.isArray(x.content)? x.content : []); }
    function read(o,p){ return p.split('.').reduce((a,k)=>a&&a[k]!=null?a[k]:undefined,o); }
    function uploaderIdOf(clip){
        return clip.uploaderId
            ?? clip.memberId ?? clip.authorId
            ?? read(clip,'uploader.id') ?? read(clip,'author.id') ?? read(clip,'member.id');
    }

    // === getJson: 204/ë¹„-JSON ì•ˆì „ ì²˜ë¦¬ & FormData í—¤ë” ìë™ ì„¤ì • ë°©ì§€ ===
    async function getJson(url, opt = {}) {
        const headers = opt.headers ? { ...opt.headers } : {};
        const hasBody = opt.body !== undefined && opt.body !== null;
        const isForm = typeof FormData !== 'undefined' && opt.body instanceof FormData;
        if (!headers['Content-Type'] && opt.method && opt.method !== 'GET' && hasBody && !isForm) {
            headers['Content-Type'] = 'application/json';
        }
        const token = getToken();
        if (token) headers['Authorization'] = token;

        const res = await fetch(url, { ...opt, headers });
        if (!res.ok) {
            const txt = await res.text().catch(()=>'');
            throw new Error(txt || `HTTP ${res.status}`);
        }
        if (res.status === 204) return null;

        const ct = res.headers.get('Content-Type') || '';
        if (ct.includes('application/json')) return res.json();
        return res.text().catch(()=>null);
    }

    async function sendMultipart(url, formData){
        const headers = {};
        const tok = getToken(); if (tok) headers['Authorization']=tok;
        const res = await fetch(url, { method:'POST', headers, body: formData });
        if(!res.ok){ const txt=await res.text().catch(()=> ''); throw new Error(txt||('HTTP '+res.status)); }
        const ct = res.headers.get('Content-Type') || '';
        if (ct.includes('application/json')) return res.json();
        return null;
    }

    // ===== state =====
    const state = {
        me:null,
        myClips:[],
        // follow modal
        sheet: {
            mode: 'followers', // 'followers' | 'following'
            page: 0,
            size: 20,
            totalPages: 1,
            userId: null, // me.id
            loading: false
        }
    };

    // ===== profile summary =====
    async function loadSummary(){
        const me = await getJson('/api/me/summary');
        state.me = me;
        $('#displayName').textContent = me.name || me.loginId || 'ë‚˜';
        applyAvatar(me.avatarUrl);

        const counts = await getJson(`/api/members/${me.id}/follow-counts`);
        $('#followerCount').textContent = counts.followers ?? 0;
        $('#followingCount').textContent = counts.following ?? 0;
    }

    // ===== my clips =====
    async function fetchMyClips(){
        try {
            const page = await getJson('/api/me/clips?page=0&size=50');
            return pickPage(page);
        } catch {
            const page = await getJson('/api/clips/feed?page=0&size=200');
            const all = pickPage(page);
            return all.filter(c => String(uploaderIdOf(c)) === String(state.me.id));
        }
    }

    async function loadMyClips(){
        const mine = await fetchMyClips();
        state.myClips = mine;
        $('#postCount').textContent = mine.length;
        renderMine(mine);
    }

    function renderMine(list){
        const box = $('#mine'); box.innerHTML='';
        if(list.length===0){ box.innerHTML = `<div class="ghost">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
        const frag = document.createDocumentFragment();
        list.forEach(c=>{
            const card = document.createElement('article'); card.className='card'; card.dataset.id=c.id;

            const v = document.createElement('video');
            v.className='thumb'; v.src = c.videoUrl || ''; v.controls = true; v.playsInline = true;
            card.appendChild(v);

            const cap = document.createElement('div'); cap.className='cap'; cap.textContent = c.caption || '';
            card.appendChild(cap);

            const row = document.createElement('div'); row.className='row';
            const edit = document.createElement('button'); edit.className='btn'; edit.textContent='í¸ì§‘';
            const del  = document.createElement('button'); del.className='btn'; del.textContent='ì‚­ì œ';

            edit.addEventListener('click', ()=> editCaption(c, cap));
            del.addEventListener('click', ()=> deleteClip(c, card));

            row.appendChild(edit); row.appendChild(del);
            row.appendChild(Object.assign(document.createElement('div'), {className:'ghost', textContent:`â™¥ ${c.likeCount??0} Â· ğŸ’¬ ${c.commentCount??0}`}));
            card.appendChild(row);

            frag.appendChild(card);
        });
        box.appendChild(frag);
    }

    // ===== actions =====
    async function editCaption(clip, capEl){
        const next = prompt('ìƒˆ ìº¡ì…˜ì„ ì…ë ¥í•˜ì„¸ìš”', (clip.caption||'').trim());
        if (next == null) return;
        try{
            await getJson(`/api/clips/${clip.id}`, { method:'PATCH', body: JSON.stringify({ caption: next }) });
            clip.caption = next; capEl.textContent = next; toast('ìˆ˜ì • ì™„ë£Œ');
        }catch(e){ console.error(e); toast('ìˆ˜ì • ì‹¤íŒ¨'); }
    }

    async function deleteClip(clip, cardEl){
        if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
        try{
            await getJson(`/api/clips/${clip.id}`, { method:'DELETE' });
            cardEl.remove();
            state.myClips = state.myClips.filter(x=>x.id!==clip.id);
            $('#postCount').textContent = state.myClips.length;
            toast('ì‚­ì œ ì™„ë£Œ');
        }catch(e){ console.error(e); toast('ì‚­ì œ ì‹¤íŒ¨(ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ í™•ì¸)'); }
    }

    // ===== avatar upload =====
    $('#avatarInput').addEventListener('change', async ()=>{
        const f = $('#avatarInput').files[0]; if(!f) return;
        const fd = new FormData(); fd.append('image', f);
        try{
            const json = await sendMultipart('/api/me/avatar', fd);
            if (json?.avatarUrl) applyAvatar(json.avatarUrl);
            toast('ì•„ë°”íƒ€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){ console.error(e); toast('ì•„ë°”íƒ€ ì—…ë¡œë“œ ì‹¤íŒ¨'); }
    });

    // ===== tabs =====
    document.querySelectorAll('.tab').forEach(t=>{
        t.addEventListener('click', ()=>{
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            t.classList.add('active');
            const key = t.dataset.tab;
            document.querySelectorAll('section.grid').forEach(s=>s.style.display='none');
            document.getElementById(key).style.display='grid';
            if(key==='saved') toast('ì €ì¥í•œ í´ë¦½ì€ ì¶”í›„ API ì—°ë™ ì˜ˆì •ì…ë‹ˆë‹¤.');
        });
    });

    // ===== share =====
    $('#shareBtn').addEventListener('click', async ()=>{
        const url = location.origin + '/users/' + (state.me?.loginId || state.me?.id || '');
        try{ await navigator.clipboard.writeText(url); toast('í”„ë¡œí•„ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        catch{ toast(url); }
    });

    // ===== íŒ”ë¡œìš° ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ =====
    const dim = $('#dim');
    const sheet = $('#followSheet');
    const listBox = $('#followList');
    const moreBtn = $('#sheetMore');
    const titleEl = $('#sheetTitle');

    function openSheet(mode){
        state.sheet.mode = mode;         // 'followers' | 'following'
        state.sheet.page = 0;
        state.sheet.totalPages = 1;
        state.sheet.userId = state.me?.id;
        titleEl.textContent = mode === 'followers' ? 'íŒ”ë¡œì›Œ' : 'íŒ”ë¡œì‰';
        listBox.innerHTML = '';
        moreBtn.style.display = 'none';

        dim.classList.add('show');
        sheet.classList.add('show');
        sheet.setAttribute('aria-hidden','false');

        loadFollowPage(); // ì²« í˜ì´ì§€ ë¡œë“œ
    }
    function closeSheet(){
        dim.classList.remove('show');
        sheet.classList.remove('show');
        sheet.setAttribute('aria-hidden','true');
    }
    $('#sheetClose').addEventListener('click', closeSheet);
    dim.addEventListener('click', closeSheet);

    async function loadFollowPage(){
        if(state.sheet.loading) return;
        const { userId, mode, page, size } = state.sheet;
        if(!userId) return;
        state.sheet.loading = true;
        try{
            const data = await getJson(`/api/members/${userId}/${mode}?page=${page}&size=${size}`);
            const items = pickPage(data);
            renderFollowItems(items);
            state.sheet.totalPages = (data?.totalPages ?? 1);
            // ë‹¤ìŒ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€
            if (state.sheet.page + 1 < state.sheet.totalPages) {
                moreBtn.style.display = 'inline-block';
            } else {
                moreBtn.style.display = 'none';
            }
        }catch(e){
            console.error(e); toast('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }finally{
            state.sheet.loading = false;
        }
    }

    function renderFollowItems(arr){
        const frag = document.createDocumentFragment();
        arr.forEach(m=>{
            const row = document.createElement('div'); row.className='person';

            const img = document.createElement('img'); img.className='pav';
            applyAvatar(m.avatarUrl, img);

            const nm = document.createElement('div');
            nm.className='pname';
            nm.textContent = (m.name && m.name.trim()) ? m.name : (m.loginId || ('ì‚¬ìš©ì#'+(m.id ?? '')));

            const right = document.createElement('div'); right.className='pright';
            const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='í”„ë¡œí•„';
            viewBtn.addEventListener('click', ()=> {
                location.href = `/user.html?userId=${encodeURIComponent(m.id)}`;
            });

            right.appendChild(viewBtn);
            row.appendChild(img);
            row.appendChild(nm);
            row.appendChild(right);

            frag.appendChild(row);
        });
        listBox.appendChild(frag);
    }

    moreBtn.addEventListener('click', ()=>{
        if (state.sheet.page + 1 < state.sheet.totalPages) {
            state.sheet.page += 1;
            loadFollowPage();
        }
    });

    // ì¹´ìš´íŠ¸ í…ìŠ¤íŠ¸ í´ë¦­ â†’ ëª¨ë‹¬ ì—´ê¸°
    $('#followersOpen').addEventListener('click', ()=> openSheet('followers'));
    $('#followingOpen').addEventListener('click', ()=> openSheet('following'));

    // ===== boot =====
    $('#refreshBtn').addEventListener('click', async ()=>{
        try{ await loadSummary(); await loadMyClips(); toast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ'); }catch{ toast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); }
    });

    (async function boot(){
        try{ await loadSummary(); await loadMyClips(); }
        catch(e){ console.error(e); toast('ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'); }
    })();
</script>
</body>
</html>
