<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Clip Upload Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; }
        h1 { font-size: 20px; }
        .row { margin: 12px 0; }
        label { display:block; font-weight: 600; margin-bottom: 6px; }
        input[type="text"] { width: 100%; padding: 8px; }
        input[type="file"] { padding: 8px 0; }
        button { padding: 10px 14px; cursor: pointer; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; margin: 16px 0; }
        pre { background: #111; color: #0f0; padding: 12px; overflow: auto; min-height: 120px; }
        small.muted { color: #777; }
        video { max-width: 100%; display: none; margin-top: 8px; }
    </style>
</head>
<body>
<h1>í´ë¦½ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h1>

<div class="row">
    <label>ì„œë²„ ë² ì´ìŠ¤ URL <small class="muted">(ë¹„ì›Œë‘ë©´ í˜„ì¬ í˜¸ìŠ¤íŠ¸ ì‚¬ìš©)</small></label>
    <input id="baseUrl" type="text" placeholder="ì˜ˆ) http://localhost:8080">
</div>

<div class="row">
    <label>JWT í† í° <small class="muted">(ì•ì— <b>Bearer</b> ì“°ì§€ ë§ê³  í† í° ë¬¸ìì—´ë§Œ!)</small></label>
    <input id="token" type="text" placeholder="eyJhbGciOi...">
</div>

<div class="row">
    <label>ìº¡ì…˜</label>
    <input id="caption" type="text" placeholder="ì˜ˆ) ì²« ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸">
</div>

<div class="row">
    <label>ë™ì˜ìƒ íŒŒì¼</label>
    <input id="video" type="file" accept="video/*">
    <video id="preview" controls></video>
</div>

<div class="actions">
    <button id="btnUpload">/api/clips ì—…ë¡œë“œ</button>
    <button id="btnWhoami">/api/auth/whoami í™•ì¸</button>
</div>

<pre id="out">ì—¬ê¸°ì— ì‘ë‹µì´ ì¶œë ¥ë©ë‹ˆë‹¤â€¦</pre>

<script>
    const $ = (id) => document.getElementById(id);
    const out = $("out");
    const video = $("video");
    const preview = $("preview");

    $("video").addEventListener("change", (e) => {
        const f = e.target.files[0];
        if (f) {
            const url = URL.createObjectURL(f);
            preview.src = url;
            preview.style.display = "block";
        } else {
            preview.removeAttribute("src");
            preview.style.display = "none";
        }
    });

    function toUrl(path) {
        const base = $("baseUrl").value.trim();
        if (!base) return path;
        return base.replace(/\/+$/, "") + path;
    }

    function authHeader() {
        const t = $("token").value.trim();
        if (!t) throw new Error("JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return "Bearer " + t; // ğŸ”´ ì—¬ê¸°ì„œ Bearer ì ‘ë‘ì‚¬ ë¶™ì—¬ì¤Œ
    }

    async function callWhoami() {
        out.textContent = "í˜¸ì¶œ ì¤‘...";
        try {
            const res = await fetch(toUrl("/api/auth/whoami"), {
                method: "GET",
                headers: { "Authorization": authHeader() }
            });
            const text = await res.text();
            out.textContent = `status=${res.status}\n` + pretty(text);
        } catch (e) {
            out.textContent = "ì—ëŸ¬: " + e;
        }
    }

    async function uploadClip() {
        out.textContent = "ì—…ë¡œë“œ ì¤‘...";
        try {
            const file = $("video").files[0];
            if (!file) { out.textContent = "ë™ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."; return; }

            const fd = new FormData();
            fd.append("caption", $("caption").value);
            fd.append("video", file);

            const res = await fetch(toUrl("/api/clips"), {
                method: "POST",
                headers: { "Authorization": authHeader() },
                body: fd
            });

            const text = await res.text();
            out.textContent = `status=${res.status}\n` + pretty(text);
        } catch (e) {
            out.textContent = "ì—ëŸ¬: " + e;
        }
    }

    function pretty(text) {
        try { return JSON.stringify(JSON.parse(text), null, 2); }
        catch { return text; }
    }

    $("btnUpload").addEventListener("click", uploadClip);
    $("btnWhoami").addEventListener("click", callWhoami);
</script>
</body>
</html>
