<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>검색 · 계정</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { color-scheme: dark light; }
        * { box-sizing: border-box; }
        body { margin:0; font-family:-apple-system, system-ui, Segoe UI, Roboto, "Noto Sans KR", sans-serif; background:#0b0b0b; color:#f2f2f2; }
        header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(8px); background:rgba(0,0,0,.6); border-bottom:1px solid rgba(255,255,255,.08); }
        .wrap { max-width:720px; margin:0 auto; padding:12px 16px; }
        .row { display:flex; align-items:center; gap:10px; }
        .title { font-weight:800; letter-spacing:.2px; }
        .btn { padding:8px 12px; border:1px solid #2a2a2a; background:#1a1a1a; color:#fff; border-radius:10px; font-size:13px; cursor:pointer; }
        .searchbar { display:flex; align-items:center; gap:8px; padding:10px 16px; }
        .searchbar input { flex:1; padding:10px 12px; border-radius:12px; border:1px solid #2a2a2a; background:#141414; color:#fff; outline:none; }
        .counter { padding:0 16px; color:#bdbdbd; font-size:12px; }
        .list { padding:6px 10px 16px; display:flex; flex-direction:column; gap:8px; }
        .item { display:flex; align-items:center; gap:12px; padding:10px 8px; border-bottom:1px solid #1b1b1b; }
        .avatar { width:44px; height:44px; border-radius:50%; background:#333; flex:0 0 auto; object-fit:cover; }
        .meta { display:flex; flex-direction:column; gap:2px; min-width:0; }
        .name { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .handle { color:#bdbdbd; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .item .btn { margin-left:auto; }
        .loadmore { display:block; margin:16px auto 28px; }
        .toast { position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#222; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #333; z-index:9999; font-size:13px; }
        @media (prefers-color-scheme: light) {
            body { background:#f7f7f8; color:#111; }
            header { background:rgba(255,255,255,.7); border-color:rgba(0,0,0,.06); }
            .btn { background:#fafafa; color:#111; border-color:#eaeaea; }
            .searchbar input { background:#fff; color:#111; border-color:#eaeaea; }
            .item { border-color:#eee; }
            .toast { background:#111; color:#fff; }
        }
    </style>
</head>
<body>
<header>
    <div class="wrap row" style="justify-content:space-between;">
        <div class="title">검색 · 계정</div>
        <button class="btn" onclick="history.back()">닫기</button>
    </div>
    <div class="wrap searchbar">
        <input id="q" type="search" placeholder="이름 또는 아이디 검색 (예: 김, min, @login)" />
        <button id="clearBtn" class="btn">취소</button>
    </div>
    <div class="wrap counter"><span id="countText">검색어를 입력하세요.</span></div>
</header>

<main class="wrap">
    <section id="list" class="list"></section>
    <button id="loadMore" class="btn loadmore" style="display:none">더 보기</button>
</main>

<div id="toast" class="toast" style="display:none"></div>

<script>
    // ===== 기본 아바타 (내장 SVG) =====
    const DEFAULT_AVATAR_DATA =
        'data:image/svg+xml;utf8,' +
        encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="88" height="88">
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#4b5563"/><stop offset="1" stop-color="#1f2937"/>
      </linearGradient></defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <circle cx="44" cy="30" r="16" fill="#9ca3af"/>
      <rect x="12" y="52" width="64" height="26" rx="13" fill="#9ca3af"/>
    </svg>`);

    // ===== utils =====
    const $ = s => document.querySelector(s);
    function toast(msg){
        const t = $('#toast'); t.textContent = msg; t.style.display = 'block';
        setTimeout(()=> t.style.display='none', 1400);
    }
    function getToken(){
        const t = localStorage.getItem('jwt') || localStorage.getItem('token');
        if (!t) return null;
        return t.startsWith('Bearer ') ? t : `Bearer ${t}`;
    }
    async function getJson(url, opt={}){
        const headers = opt.headers ? { ...opt.headers } : {};
        const hasBody = opt.body !== undefined && opt.body !== null;
        const isForm = typeof FormData !== 'undefined' && opt.body instanceof FormData;
        if (!headers['Content-Type'] && opt.method && opt.method !== 'GET' && hasBody && !isForm) {
            headers['Content-Type'] = 'application/json';
        }
        const tk = getToken(); if (tk) headers['Authorization'] = tk;
        const res = await fetch(url, { ...opt, headers });
        if (!res.ok) { throw new Error(await res.text().catch(()=>'')); }
        if (res.status === 204) return null;
        const ct = res.headers.get('Content-Type') || '';
        return ct.includes('application/json') ? res.json() : res.text();
    }
    function applyAvatar(imgEl, url){
        imgEl.onerror = null;
        if (!url) { imgEl.src = DEFAULT_AVATAR_DATA; return; }
        imgEl.onerror = () => { imgEl.onerror = null; imgEl.src = DEFAULT_AVATAR_DATA; };
        imgEl.src = url;
    }
    function debounce(fn, ms){
        let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); };
    }
    function pickPage(x){ return Array.isArray(x) ? x : (x && Array.isArray(x.content) ? x.content : []); }

    // ===== state =====
    const state = { q:'', page:0, size:20, totalPages:1, loading:false, items:[] };

    // ===== fetch & render =====
    async function search(reset=false){
        if (state.loading) return;
        if (reset) { state.page = 0; state.totalPages = 1; state.items = []; $('#list').innerHTML=''; }
        if (!state.q.trim()) {
            $('#countText').textContent = '검색어를 입력하세요.';
            $('#loadMore').style.display = 'none';
            return;
        }
        state.loading = true;
        try{
            const data = await getJson(`/api/members/search?q=${encodeURIComponent(state.q)}&page=${state.page}&size=${state.size}`);
            const content = pickPage(data);
            const totalPages = (data && typeof data.totalPages === 'number') ? data.totalPages : (content.length < state.size ? state.page+1 : state.page+2);
            state.totalPages = totalPages;
            state.items.push(...content);
            render(content, state.page > 0);
            $('#countText').textContent = `총 ${state.items.length}${data?.totalElements!=null ? ' / ' + data.totalElements : ''}명`;
            $('#loadMore').style.display = (state.page + 1 < state.totalPages) ? 'block' : 'none';
        }catch(e){
            console.error(e); toast('검색 실패');
        }finally{
            state.loading = false;
        }
    }

    function render(newItems, append){
        const list = $('#list');
        const frag = document.createDocumentFragment();
        newItems.forEach(m => frag.appendChild(buildRow(m)));
        if (append) list.appendChild(frag); else { list.innerHTML=''; list.appendChild(frag); }
    }

    function buildRow(m){
        const row = document.createElement('div'); row.className = 'item';

        const img = document.createElement('img'); img.className = 'avatar';
        applyAvatar(img, m.avatarUrl);
        row.appendChild(img);

        const meta = document.createElement('div'); meta.className = 'meta';
        const name = document.createElement('div'); name.className='name'; name.textContent = m.name || m.loginId || '사용자';
        const handle = document.createElement('div'); handle.className='handle'; handle.textContent = m.loginId ? '@'+m.loginId : '';
        meta.appendChild(name); meta.appendChild(handle);
        meta.addEventListener('click', ()=> location.href = `/user.html?userId=${encodeURIComponent(m.id)}`);
        row.appendChild(meta);

        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='팔로우';
        btn.dataset.following = '0';
        btn.addEventListener('click', ()=> toggleFollow(m.id, btn));
        row.appendChild(btn);

        // 초기 팔로잉 상태 로드(선택)
        loadRelation(m.id, btn).catch(()=>{});

        return row;
    }

    async function loadRelation(userId, btn){
        try{
            const d = await getJson(`/api/members/${encodeURIComponent(userId)}/relation`);
            setFollowBtn(btn, !!d.following);
        }catch{ /* 비로그인 등은 무시 */ }
    }
    function setFollowBtn(btn, following){
        btn.dataset.following = following ? '1' : '0';
        btn.textContent = following ? '언팔로우' : '팔로우';
    }
    async function toggleFollow(targetId, btn){
        const following = btn.dataset.following === '1';
        try{
            if (following){
                await getJson(`/api/members/${encodeURIComponent(targetId)}/follow`, { method:'DELETE' });
                setFollowBtn(btn, false);
                toast('언팔로우 완료');
            }else{
                await getJson(`/api/members/${encodeURIComponent(targetId)}/follow`, { method:'POST' });
                setFollowBtn(btn, true);
                toast('팔로우 완료');
            }
        }catch(e){
            console.error(e); toast('처리 실패');
        }
    }

    // ===== events =====
    const doSearch = debounce(()=> search(true), 300);
    $('#q').addEventListener('input', (e)=>{ state.q = e.target.value; doSearch(); });
    $('#q').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); state.q = e.target.value; search(true); }});
    $('#clearBtn').addEventListener('click', ()=>{ $('#q').value=''; state.q=''; $('#list').innerHTML=''; $('#countText').textContent='검색어를 입력하세요.'; $('#loadMore').style.display='none'; });

    $('#loadMore').addEventListener('click', ()=>{
        if (state.page + 1 < state.totalPages) { state.page += 1; search(false); }
    });

    // ===== boot (최근 검색어 유지하고 싶으면 localStorage에 state.q 저장/복원하면 됨) =====
    // 초기 포커스
    document.getElementById('q').focus();
</script>
</body>
</html>
