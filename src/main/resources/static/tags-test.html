<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>태그 테스트 페이지</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; }
        * { box-sizing: border-box; }
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--fg); }
        .wrap { max-width: 920px; margin: 40px auto; padding: 0 16px; }
        h1 { font-size: 22px; margin: 0 0 16px; }
        .card { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:16px; margin-bottom:16px; }
        label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
        input[type="text"], input[type="number"] {
            width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:var(--fg);
        }
        .row { display:grid; gap:12px; grid-template-columns: 1fr 110px 110px; }
        .row.sm { grid-template-columns: 1fr 1fr; }
        button {
            padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:var(--fg);
            cursor:pointer;
        }
        button.primary { border-color:transparent; background:linear-gradient(90deg, #06b6d4, #3b82f6); color:white; }
        .list { display:grid; gap:10px; }
        .item { border:1px solid #1f2937; border-radius:12px; padding:10px 12px; background:#0b1220; }
        .muted { color:var(--muted); font-size:12px; }
        .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0ea5e9; color:white; font-size:12px; margin-left:8px; }
        pre { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:12px; overflow:auto; }
        a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
<div class="wrap">

    <h1>태그 API 간단 테스트</h1>

    <!-- 토큰(선택) -->
    <div class="card">
        <label>Authorization (선택, Bearer 토큰)</label>
        <input id="token" type="text" placeholder="예) eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
        <div class="muted" style="margin-top:6px">GET 요청은 보통 토큰이 필요 없습니다. 업로드 등 테스트할 때만 넣으세요.</div>
    </div>

    <!-- 태그 목록 조회 -->
    <div class="card">
        <div class="row sm">
            <button class="primary" id="btnLoadTags">태그 목록 불러오기</button>
            <button id="btnClearTags">지우기</button>
        </div>
        <div id="tagsList" class="list" style="margin-top:12px"></div>
    </div>

    <!-- 태그로 클립 검색 -->
    <div class="card">
        <div class="row" style="align-items:end">
            <div>
                <label>검색 태그</label>
                <input id="tagInput" type="text" placeholder="예) 인천_공연 또는 #인천_공연" />
            </div>
            <div>
                <label>page</label>
                <input id="pageInput" type="number" min="0" value="0" />
            </div>
            <div>
                <label>size</label>
                <input id="sizeInput" type="number" min="1" value="10" />
            </div>
        </div>
        <div class="row sm" style="margin-top:12px">
            <button class="primary" id="btnSearch">태그로 검색</button>
            <button id="btnClearClips">지우기</button>
        </div>

        <div id="clipsList" class="list" style="margin-top:12px"></div>
    </div>

    <!-- 원시 응답 보기 -->
    <div class="card">
        <div class="row sm">
            <button id="btnShowLast">마지막 응답 보기</button>
            <button id="btnClearRaw">지우기</button>
        </div>
        <pre id="raw" style="margin-top:12px; display:none;"></pre>
    </div>

    <div class="muted">엔드포인트: <code>/api/tags</code>, <code>/api/tags/clips?tag=xxx&amp;page=&amp;size=</code></div>

</div>

<script>
    const $ = (sel) => document.querySelector(sel);
    const tokenEl = $('#token');
    const tagsListEl = $('#tagsList');
    const clipsListEl = $('#clipsList');
    const rawEl = $('#raw');
    let lastResponse = null;

    function headers() {
        const h = { 'Accept': 'application/json' };
        const t = tokenEl.value.trim();
        if (t) h['Authorization'] = t.startsWith('Bearer ') ? t : 'Bearer ' + t;
        return h;
    }

    // 태그 목록 불러오기
    $('#btnLoadTags').addEventListener('click', async () => {
        try {
            const res = await fetch('/api/tags', { headers: headers() });
            lastResponse = await res.json();
            if (!Array.isArray(lastResponse)) throw new Error('응답 형식이 배열이 아님');
            tagsListEl.innerHTML = '';
            lastResponse.forEach(t => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
          <div><strong>#${escapeHtml(t.name)}</strong>
            <span class="pill">count ${t.usageCount ?? 0}</span>
          </div>
          <div class="muted">normalized: ${escapeHtml(t.normalizedName)}</div>
          <div style="margin-top:6px"><button data-tag="${t.name}">이 태그로 검색</button></div>
        `;
                div.querySelector('button').addEventListener('click', () => {
                    $('#tagInput').value = t.name;
                    $('#btnSearch').click();
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                });
                tagsListEl.appendChild(div);
            });
        } catch (e) {
            alert('태그 목록 불러오기 실패: ' + e.message);
        }
    });

    $('#btnClearTags').addEventListener('click', () => tagsListEl.innerHTML = '');

    // 태그로 클립 검색
    $('#btnSearch').addEventListener('click', async () => {
        const tag = $('#tagInput').value.trim();
        const page = parseInt($('#pageInput').value || '0', 10);
        const size = parseInt($('#sizeInput').value || '10', 10);
        if (!tag) { alert('태그를 입력하세요.'); return; }

        const url = `/api/tags/clips?tag=${encodeURIComponent(tag)}&page=${page}&size=${size}`;
        try {
            const res = await fetch(url, { headers: headers() });
            lastResponse = await res.json(); // Spring Page response
            const content = Array.isArray(lastResponse?.content) ? lastResponse.content : [];
            clipsListEl.innerHTML = '';
            content.forEach(c => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
          <div><strong>Clip #${c.id}</strong></div>
          <div class="muted" style="margin-top:4px">${escapeHtml(c.caption ?? '')}</div>
          <div class="muted" style="margin-top:4px">uploaderId: ${c.uploaderId ?? '-'}</div>
        `;
                clipsListEl.appendChild(div);
            });
            // 페이지 정보 하단에 표시
            const info = document.createElement('div');
            info.className = 'muted';
            info.style.marginTop = '6px';
            info.textContent = `totalElements=${lastResponse.totalElements ?? 0}, totalPages=${lastResponse.totalPages ?? 0}, number=${lastResponse.number ?? 0}, size=${lastResponse.size ?? 0}`;
            clipsListEl.appendChild(info);
        } catch (e) {
            alert('태그 검색 실패: ' + e.message);
        }
    });

    $('#btnClearClips').addEventListener('click', () => clipsListEl.innerHTML = '');

    // 원시 응답 보기
    $('#btnShowLast').addEventListener('click', () => {
        rawEl.style.display = 'block';
        rawEl.textContent = safeStringify(lastResponse);
    });
    $('#btnClearRaw').addEventListener('click', () => {
        rawEl.style.display = 'none';
        rawEl.textContent = '';
    });

    // helpers
    function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"'`=\/]/g, (c) =>
            ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));
    }
    function safeStringify(obj) {
        try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
    }
</script>
</body>
</html>
