<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>클립 랭킹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { color-scheme: dark light; }
        * { box-sizing: border-box; }
        body { margin:0; font-family:-apple-system, system-ui, Segoe UI, Roboto, "Noto Sans KR", sans-serif; background:#0b0b0b; color:#f2f2f2; }
        header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(8px); background:rgba(0,0,0,.6); border-bottom:1px solid rgba(255,255,255,.08); }
        .wrap { max-width:760px; margin:0 auto; padding:0 16px; }
        header .bar { display:flex; align-items:center; justify-content:space-between; padding:12px 0; }
        .title { font-weight:800; letter-spacing:.3px; }
        .btn { padding:8px 12px; border:1px solid #2a2a2a; background:#1a1a1a; color:#fff; border-radius:10px; font-size:13px; cursor:pointer; }
        .btn:disabled { opacity:.5; cursor:not-allowed; }
        .controls { display:flex; gap:10px; align-items:center; padding:14px 0; border-bottom:1px solid #222; flex-wrap:wrap; }
        .chip { padding:8px 10px; border:1px solid #2a2a2a; background:#151515; border-radius:999px; font-size:13px; cursor:pointer; }
        .chip.active { border-color:#8b5cf6; }
        input[type=datetime-local] { padding:8px 10px; border-radius:10px; border:1px solid #2a2a2a; background:#141414; color:#fff; outline:none; font-size:13px; }
        .list { padding:12px 0 28px; }
        .row { display:grid; grid-template-columns: 44px 1fr auto; gap:10px; align-items:center; padding:10px 0; border-bottom:1px solid #1b1b1b; }
        .rank { font-weight:800; text-align:center; }
        .main { display:flex; flex-direction:column; gap:4px; }
        .name a { color:inherit; text-decoration:none; font-weight:800; }
        .name a:hover { text-decoration:underline; }
        .meta { color:#bdbdbd; font-size:12px; }
        .likes { font-weight:800; }
        .pager { display:flex; justify-content:center; gap:10px; padding:10px 0 24px; position:sticky; bottom:0; backdrop-filter:saturate(180%) blur(8px); background:rgba(0,0,0,.4); border-top:1px solid #222; }
        .toast { position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#222; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #333; font-size:13px; }
        .ghost { opacity:.7; }
        @media (prefers-color-scheme: light) {
            body { background:#f7f7f8; color:#111; }
            header { background:rgba(255,255,255,.7); border-color:rgba(0,0,0,.06); }
            .btn { background:#fafafa; color:#111; border-color:#eaeaea; }
            .chip { background:#fff; border-color:#eaeaea; }
            input[type=datetime-local] { background:#fff; color:#111; border-color:#eaeaea; }
            .row { border-color:#eee; }
            .pager { background:rgba(255,255,255,.7); border-color:#eee; }
            .toast { background:#111; color:#fff; }
        }
    </style>
</head>
<body>
<header>
    <div class="bar wrap">
        <div class="title">클립 랭킹</div>
        <button id="refreshBtn" class="btn">새로고침</button>
    </div>
</header>

<main class="wrap">
    <section class="controls">
        <div class="chip" data-period="all">전체</div>
        <div class="chip" data-period="24h">24시간</div>
        <div class="chip" data-period="7d">7일</div>
        <div class="chip" data-period="30d">30일</div>
        <div style="display:flex; gap:8px; align-items:center;">
            <label class="ghost" for="sinceInput">직접: </label>
            <input id="sinceInput" type="datetime-local" />
            <button id="applySince" class="btn">적용</button>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <label class="ghost" for="sizeSel">페이지 크기</label>
            <select id="sizeSel" class="btn" style="padding:8px 10px;">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
            </select>
        </div>
    </section>

    <section id="list" class="list"></section>

    <nav class="pager">
        <button id="prevBtn" class="btn">이전</button>
        <div id="pageInfo" class="ghost">0 / 0</div>
        <button id="nextBtn" class="btn">다음</button>
    </nav>
</main>

<script>
    // ====== auth ======
    function getToken() {
        const t = localStorage.getItem('token') || localStorage.getItem('jwt');
        if (!t) return null;
        return t.startsWith('Bearer ') ? t : `Bearer ${t}`;
    }

    // ====== utils ======
    function toast(msg) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 1400);
    }
    function fmtNumber(n){ try { return Number(n).toLocaleString(); } catch { return String(n ?? '0'); } }

    async function getJson(url, opt = {}) {
        const headers = opt.headers ? { ...opt.headers } : {};
        if (!headers['Content-Type'] && opt.method && opt.method !== 'GET') headers['Content-Type'] = 'application/json';
        const token = getToken(); if (token) headers['Authorization'] = token;
        const res = await fetch(url, { ...opt, headers });
        if (!res.ok) {
            const txt = await res.text().catch(()=> '');
            throw new Error(txt || 'request failed');
        }
        const ct = res.headers.get('Content-Type') || '';
        if (ct.includes('application/json')) return res.json();
        return res.text().catch(()=>null);
    }

    function pageMeta(x) {
        if (!x || Array.isArray(x)) return { number: 0, totalPages: 1, content: (Array.isArray(x)?x:[]) };
        return {
            number: x.number ?? 0,
            totalPages: x.totalPages ?? 1,
            size: x.size ?? 0,
            totalElements: x.totalElements ?? 0,
            content: Array.isArray(x.content) ? x.content : []
        };
    }

    // ====== state ======
    const state = {
        page: 0,
        size: 20,
        totalPages: 1,
        sinceISO: null, // ISO string or null
        loading: false
    };

    // ====== UI wiring ======
    const listEl = document.getElementById('list');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const sizeSel = document.getElementById('sizeSel');
    const sinceInput = document.getElementById('sinceInput');

    document.getElementById('refreshBtn').addEventListener('click', () => load(true));

    sizeSel.addEventListener('change', () => {
        state.size = Number(sizeSel.value || 20);
        state.page = 0;
        load(true);
    });

    document.querySelectorAll('.chip').forEach(ch => {
        ch.addEventListener('click', () => {
            document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
            ch.classList.add('active');
            const p = ch.dataset.period;
            state.sinceISO = computeSince(p);
            if (p === 'all') {
                sinceInput.value = '';
            } else {
                // 미리 input에도 반영(현지 로컬 시간값으로 변환)
                const d = state.sinceISO ? new Date(state.sinceISO) : null;
                sinceInput.value = d ? toLocalDatetimeValue(d) : '';
            }
            state.page = 0;
            load(true);
        });
    });

    document.getElementById('applySince').addEventListener('click', () => {
        const v = sinceInput.value; // "YYYY-MM-DDTHH:mm"
        if (!v) {
            state.sinceISO = null; // 전체
            document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
        } else {
            // 로컬 -> ISO
            const local = new Date(v);
            if (isNaN(local.getTime())) return toast('잘못된 날짜/시간');
            state.sinceISO = local.toISOString();
            document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
        }
        state.page = 0;
        load(true);
    });

    prevBtn.addEventListener('click', () => {
        if (state.page > 0) { state.page -= 1; load(); }
    });
    nextBtn.addEventListener('click', () => {
        if (state.page + 1 < state.totalPages) { state.page += 1; load(); }
    });

    function computeSince(period) {
        const now = Date.now();
        if (period === '24h') return new Date(now - 24*60*60*1000).toISOString();
        if (period === '7d') return new Date(now - 7*24*60*60*1000).toISOString();
        if (period === '30d') return new Date(now - 30*24*60*60*1000).toISOString();
        return null; // all
    }
    function toLocalDatetimeValue(d) {
        // yyyy-MM-ddTHH:mm (로컬)
        const pad = (n)=> String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ====== data load & render ======
    async function load(reset = false) {
        if (state.loading) return;
        state.loading = true;
        try {
            if (reset) listEl.innerHTML = '';
            const params = new URLSearchParams();
            if (state.sinceISO) params.set('since', state.sinceISO);
            params.set('page', state.page);
            params.set('size', state.size);
            // 정렬은 컨트롤러의 @PageableDefault 가 likeCount desc 이므로 생략 가능

            const data = await getJson(`/api/ranking/clips?${params.toString()}`);
            const meta = pageMeta(data);
            state.totalPages = meta.totalPages ?? 1;
            render(meta.content);
            pageInfo.textContent = `${meta.number + 1} / ${state.totalPages}`;
            prevBtn.disabled = (state.page <= 0);
            nextBtn.disabled = (state.page + 1 >= state.totalPages);
        } catch (e) {
            console.error(e);
            toast('랭킹 불러오기 실패');
        } finally {
            state.loading = false;
        }
    }

    function render(items) {
        if (!items || items.length === 0) {
            listEl.innerHTML = '<div class="ghost" style="padding:14px 0;">데이터가 없습니다.</div>';
            return;
        }
        const frag = document.createDocumentFragment();
        items.forEach((r, i) => {
            const row = document.createElement('div');
            row.className = 'row';

            const rank = document.createElement('div');
            rank.className = 'rank';
            rank.textContent = (state.page * state.size) + i + 1;

            const main = document.createElement('div');
            main.className = 'main';
            const name = document.createElement('div');
            name.className = 'name';
            const a = document.createElement('a');
            a.href = `/user.html?userId=${encodeURIComponent(r.uploaderId)}`;
            a.textContent = r.uploaderName || `사용자#${r.uploaderId}`;
            name.appendChild(a);
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = `clipId: ${r.clipId}`;
            main.appendChild(name);
            main.appendChild(meta);

            const right = document.createElement('div');
            right.className = 'likes';
            right.textContent = `♥ ${fmtNumber(r.likeCount)}`;

            row.appendChild(rank);
            row.appendChild(main);
            row.appendChild(right);

            // (선택) 클릭 시 클립 상세로 이동하고 싶다면 아래 주석 해제 (해당 페이지가 있을 때)
            // row.style.cursor = 'pointer';
            // row.addEventListener('click', () => location.href = `/clip.html?clipId=${encodeURIComponent(r.clipId)}`);

            frag.appendChild(row);
        });
        listEl.innerHTML = '';
        listEl.appendChild(frag);
    }

    // ====== boot ======
    (function boot(){
        // 기본: 7일 버튼 활성화 예시 → 필요 없으면 주석
        // document.querySelector('.chip[data-period="7d"]')?.click();
        // 기본은 '전체'
        document.querySelector('.chip[data-period="all"]')?.classList.add('active');
        load(true);
    })();
</script>
</body>
</html>
