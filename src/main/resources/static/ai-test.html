<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>핫플·루트 – 데이트 경로 추천 (AI)</title>
    <style>
        :root{--bg:#fff2ea;--surface:#fff;--brand:#ff7e43;--brand-ink:#fff;--ink:#2a2a2a;--muted:#7b7b7b;--chip:#ffe7da;--shadow:0 10px 30px rgba(0,0,0,.08);--r:24px}
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;background:var(--bg);color:var(--ink);display:flex;justify-content:center}
        .app{max-width:520px;width:100%;min-height:100dvh;padding:20px}
        header{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 18px}
        .logo{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--brand)}
        .logo-dot{width:10px;height:10px;background:var(--brand);border-radius:50%;box-shadow:14px 0 0 var(--brand),28px 0 0 var(--brand);margin-right:6px}
        .badge{border:1px solid #ffd6bd;background:#fff;border-radius:12px;padding:8px 10px;font-weight:800;color:#a85b32}
        .hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px 12px 8px}
        .hero p{margin:0;text-align:center;color:var(--muted);line-height:1.5}
        .tiger{width:120px;height:120px;border-radius:28px;background:#fff;border:8px solid #ffd6bd;position:relative;box-shadow:var(--shadow);margin-top:6px}
        .tiger:before,.tiger:after{content:"";position:absolute;background:#ffd3b3;width:28px;height:28px;border-radius:50%}
        .tiger:before{left:-6px;bottom:10px}.tiger:after{right:-6px;bottom:10px}
        .book{position:absolute;left:50%;bottom:-2px;transform:translateX(-50%);width:120px;height:60px;background:var(--brand);border-radius:10px 10px 18px 18px;box-shadow:0 8px 20px rgba(255,126,67,.35)}
        .panel{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin:14px 0}
        .q{font-weight:800;margin:2px 0 12px}
        .chips{display:flex;flex-wrap:wrap;gap:10px}
        .chip{padding:12px 14px;border-radius:999px;background:var(--chip);border:1px solid transparent;cursor:pointer;font-weight:700;color:var(--ink);transition:all .15s ease}
        .chip[aria-pressed="true"]{background:var(--brand);color:var(--brand-ink);box-shadow:0 6px 16px rgba(242,106,45,.28)}
        .chip:active{transform:translateY(1px)}
        .cta{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center}
        .btn{border:0;border-radius:16px;padding:14px 18px;font-weight:800;cursor:pointer;background:var(--brand);color:#fff;box-shadow:0 10px 24px rgba(242,106,45,.35);width:100%}
        .btn:active{transform:translateY(1px)}
        .loading{display:none;align-items:center;gap:8px;color:var(--muted);padding:6px 4px}
        .loading.active{display:flex}
        .err{display:none;background:#fff1f1;border:1px solid #ffd6d6;color:#a80000;padding:12px;border-radius:12px;margin-top:10px}
        .result{margin-top:14px;display:none}
        .result.active{display:block}
        .summary{color:#7b7b7b;margin:6px 2px 10px}
        .section-title{font-weight:900;margin:10px 6px 6px}
        .card{background:var(--surface);border-radius:18px;box-shadow:var(--shadow);padding:14px;margin:10px 0;display:grid;grid-template-columns:48px 1fr auto;gap:12px;align-items:center}
        .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;background:#fff3ec}
        .title{font-weight:800;display:flex;align-items:center;gap:6px}
        .sub{color:#7b7b7b;font-size:13px}
        .stars{color:#f7b500;white-space:nowrap}
        .label-dot{font-weight:800;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#ffe7da}
        .link a{display:inline-block;text-decoration:none;color:#f26a2d;font-weight:800;padding:10px 12px;border-radius:12px;border:1px solid #ffe0cf;background:#fff}
        .course{padding:12px;border-radius:16px;background:var(--surface);box-shadow:var(--shadow);margin:12px 0}
        .course-head{font-weight:900;margin-bottom:6px}
        .course-desc{color:#6e6e6e;margin:4px 0 6px}
        .list-item{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;border-radius:14px;background:#fff;border:1px solid #ffe0cf;box-shadow:var(--shadow);margin:10px 0;cursor:pointer}
        .list-title{font-weight:900}
        .pill{padding:6px 8px;border-radius:999px;background:#fff6ef;border:1px solid #ffd8c3;font-size:12px;color:#a85b32;margin-right:6px}
        .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:8px 2px 0}
        .t-btn{padding:10px 12px;border-radius:12px;border:1px solid #ffd6bd;background:#fff;font-weight:800;cursor:pointer}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="logo"><span class="logo-dot"></span>핫플·루트</div>
        <div>
            <span id="authBadge" class="badge">연동 확인중…</span>
            <button class="t-btn" id="openListBtn" style="margin-left:8px">저장목록</button>
        </div>
    </header>

    <!-- ====== 빌더 화면 ====== -->
    <section id="builder">
        <section class="hero">
            <div class="tiger"><div class="book"></div></div>
            <p>누구랑 전시·공연 보러왔나요?<br/>어떤 분위기를 원하나요?</p>
        </section>

        <section class="panel">
            <div class="q">① 누구랑 왔나요?</div>
            <div class="chips" id="companions">
                <button class="chip" data-value="연인" aria-pressed="true">연인</button>
                <button class="chip" data-value="친구">친구</button>
                <button class="chip" data-value="혼자">혼자</button>
                <button class="chip" data-value="가족">가족</button>
            </div>
        </section>

        <section class="panel">
            <div class="q">② 어떻게 이동하나요?</div>
            <div class="chips" id="mobility">
                <button class="chip" data-value="도보" aria-pressed="true">도보</button>
                <button class="chip" data-value="자전거">자전거</button>
                <button class="chip" data-value="대중교통">대중교통</button>
                <button class="chip" data-value="차">차</button>
            </div>
        </section>

        <section class="panel">
            <div class="q">③ 어디를 가고싶나요? (최대 4개)</div>
            <div class="chips" id="tags"></div>
        </section>

        <section class="panel">
            <div class="q">④ 어디 근처로 잡을까요?</div>
            <div class="chips" id="venue">
                <button class="chip" data-value="떼아뜨르다락소극장" aria-pressed="true">떼아뜨르다락소극장</button>
                <button class="chip" data-value="신포 아트홀">신포 아트홀</button>
            </div>
            <div class="cta"><button class="btn" id="goBtn">코스 추천받기</button></div>
            <div class="loading" id="loading">⏳ 추천 코스를 계산 중…</div>
            <div class="err" id="err"></div>
        </section>

        <section class="result" id="result">
            <div class="summary" id="summary"></div>
            <div id="cards"></div>
            <div class="cta" style="margin-top:16px;">
                <button class="btn" id="rerollBtn" style="max-width:180px;">다시 돌리기</button>
                <button class="btn" id="saveBtn" style="max-width:180px;background:#bbb;">저장하기</button>
            </div>
        </section>
    </section>

    <!-- ====== 저장 목록 화면 ====== -->
    <section id="savedList" style="display:none">
        <div class="panel">
            <div class="q">저장 목록</div>
            <div class="toolbar">
                <button class="t-btn" id="backToBuilder">← 코스 만들기</button>
                <button class="t-btn" id="refreshList">↻ 새로고침</button>
            </div>
            <div id="listBox" style="margin-top:8px;"></div>
        </div>
    </section>

    <!-- ====== 저장 상세 화면 ====== -->
    <section id="savedDetail" style="display:none">
        <div class="panel">
            <div class="q" id="detailTitle">저장한 코스</div>
            <div class="toolbar">
                <button class="t-btn" id="detailBack">← 목록</button>
                <button class="t-btn" id="detailShare">🔗 공유</button>
                <button class="t-btn" id="detailDelete" style="color:#b00000;border-color:#ffb3b3;background:#fff5f5">🗑 삭제</button>
            </div>
            <div class="summary" id="detailMeta"></div>
            <div id="detailCards"></div>
        </div>
    </section>
</div>

<script>
    /* ==========================
       공통: 인증/JWT 유틸
    ========================== */
    const API_BASE = '/api/me/routes';

    // URL 파라미터에서 토큰 전달받아 저장 (?token= or ?access_token=)
    (function takeTokenFromURL(){
        const u = new URL(location.href);
        const t = u.searchParams.get('token') || u.searchParams.get('access_token');
        if (t) {
            localStorage.setItem('accessToken', t);
            u.searchParams.delete('token'); u.searchParams.delete('access_token');
            history.replaceState({}, '', u.toString());
        }
    })();

    // postMessage로 상위/다른 창에서 토큰 전달받기
    window.addEventListener('message', (e) => {
        const d = e.data;
        if (d && d.type === 'SET_ACCESS_TOKEN' && typeof d.token === 'string') {
            localStorage.setItem('accessToken', d.token);
            const badge = document.getElementById('authBadge');
            if (badge) { badge.textContent = '연동됨'; badge.style.display = ''; }
        }
    });

    function getCookie(name){
        const m = document.cookie.match(new RegExp('(?:^|; )'+name+'=([^;]+)'));
        return m ? decodeURIComponent(m[1]) : null;
    }

    function parseJwtExp(token){
        try{
            const p = JSON.parse(atob(token.split('.')[1]));
            return typeof p.exp === 'number' ? p.exp : 0;
        }catch(_){ return 0; }
    }


    function getJwt(){
        const candidates = [
            localStorage.getItem('accessToken'),
            localStorage.getItem('jwt'),
            sessionStorage.getItem('accessToken'),
            // 쿠키도 후보에 넣기(쿠키가 HttpOnly면 여기엔 안 잡힙니다)
            getCookie('accessToken')
        ].filter(Boolean);

        const now = Math.floor(Date.now()/1000);
        const valid = candidates
            .map(t => ({ t, exp: parseJwtExp(t) }))
            .filter(x => x.exp > now);

        // 가장 늦게 만료되는 토큰을 사용
        valid.sort((a,b)=> b.exp - a.exp);
        return valid.length ? valid[0].t : null;
    }

    async function fetchWithAuth(url, opts = {}) {
        const token = getJwt();
        const headers = new Headers(opts.headers || {});
        headers.set('Accept', 'application/json');
        if (opts.body && !headers.has('Content-Type')) headers.set('Content-Type', 'application/json');
        if (token) headers.set('Authorization', 'Bearer ' + token);

        const res = await fetch(url, { ...opts, headers, credentials: 'include' });

        if (res.status === 401) {
            // 외부 로그인만 신뢰: 여기서는 아무 것도 표시/리다이렉트하지 않음
            throw new Error('Unauthorized');
        }
        return res;
    }

    (function initAuthBadge() {
        const badge = document.getElementById('authBadge');
        if (!badge) return;
        const t = getJwt();
        if (t) {
            badge.textContent = '연동됨';
        } else {
            // 로그인 요구 문구 표시하지 않기 위해 숨김
            badge.style.display = 'none';
        }
    })();

    /* ==========================
       칩/선택 공통
    ========================== */
    function showView(view){
        document.getElementById('builder').style.display = (view==='builder')?'block':'none';
        document.getElementById('savedList').style.display = (view==='list')?'block':'none';
        document.getElementById('savedDetail').style.display = (view==='detail')?'block':'none';
        if(view==='builder'){ window.history.replaceState({},'',location.pathname); }
    }

    function setupChips(id, single=true){
        const box=document.getElementById(id);
        box.addEventListener('click',(e)=>{
            const b=e.target.closest('.chip'); if(!b) return;
            if(single){ box.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false')); }
            b.setAttribute('aria-pressed', String(b.getAttribute('aria-pressed')!=='true'));
        });
    }
    ['companions','mobility','venue'].forEach(id=>setupChips(id));
    const pickedSingle = id => (document.querySelector(`#${id} .chip[aria-pressed="true"]`)||{}).dataset?.value || null;

    /* 장소 프리셋 */
    const VENUES = {
        "떼아뜨르다락소극장": {lat:37.473108,lng:126.625204,addr:"인천 중구 신포로27번길 3 3층"},
        "신포 아트홀": {lat:37.47344,lng:126.62465,addr:"인천 중구 신포로31번길 6"}
    };
    async function resolveVenue(){
        const name = pickedSingle('venue') || '떼아뜨르다락소극장';
        if (VENUES[name]) return { name, lat: VENUES[name].lat, lng: VENUES[name].lng };
        try{
            const r = await fetch(`/places/kakao?query=${encodeURIComponent(name)}&size=1`, {headers:{'Accept':'application/json'}});
            if(r.ok){
                const arr = await r.json();
                if(Array.isArray(arr) && arr[0]) return { name, lat: arr[0].lat, lng: arr[0].lng };
            }
        }catch(_){}
        return { name, lat: 37.5665, lng: 126.9780 };
    }

    /* 태그(최대 4) */
    const ALL_TAGS = [
        '볼거리','지역문화','전시','시장','자연','명소','축제',
        '놀거리','쉼자리','먹을거리',
        '점심식사','저녁식사','브런치','커피','디저트','술','산책로'
    ];
    const TAG_TO_QUERY = {
        '지역문화': '문화거리 OR 전통문화 OR 거리공연 OR 역사',
        '전시': '전시 OR 미술관 OR 박물관',
        '시장': '전통시장 OR 재래시장',
        '자연': '자연경관 OR 생태공원',
        '명소': '관광명소 OR 포토스팟',
        '축제': '축제',
        '산책로': '산책로 OR 공원',
        '점심식사': '맛집 OR 식당',
        '저녁식사': '맛집 OR 식당',
        '브런치': '브런치 카페',
        '커피': '카페',
        '디저트': '디저트 카페 OR 베이커리',
        '술': '술집 OR 포차',
        '볼거리': null, '놀거리': null, '쉼자리': null, '먹을거리': null
    };
    const ACTIVITY_TAGS = new Set(['지역문화','전시','시장','자연','명소','축제','산책로']);
    (function renderTagPanel(){
        const box = document.getElementById('tags');
        box.innerHTML = ALL_TAGS.map(t=>`<button class="chip" data-value="${t}">${t}</button>`).join('');
        box.addEventListener('click', e=>{
            const b = e.target.closest('.chip'); if(!b) return;
            const willSelect = b.getAttribute('aria-pressed')!=='true';
            const selected = [...box.querySelectorAll('.chip[aria-pressed="true"]')];
            if(willSelect && selected.length >= 4) return;
            b.setAttribute('aria-pressed', String(willSelect));
        });
    })();
    const pickedTags = () => [...document.querySelectorAll('#tags .chip[aria-pressed="true"]')].map(b=>b.dataset.value);

    /* 검색/ID 유틸 */
    function ideaId(name, lat, lng){
        const raw = `${name}|${(+lat).toFixed(6)}|${(+lng).toFixed(6)}`;
        const b64 = btoa(unescape(encodeURIComponent(raw))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
        return b64;
    }


    function parseIdeaId(id){
        try{
            const raw = decodeURIComponent(escape(atob(id.replace(/-/g,'+').replace(/_/g,'/'))));
            const [name, lat, lng] = raw.split('|');
            return { name, lat: Number(lat), lng: Number(lng) };
        }catch(_){ return null; }
    }
    function parseKakaoToLink(link){
        if(!link) return null;
        const m = link.match(/\/to\/([^,]+),([^,]+),([^,]+)/);
        if(!m) return null;
        return { name: decodeURIComponent(m[1]), lat: Number(m[2]), lng: Number(m[3]) };
    }
    async function searchCandidates(query, lat, lng, radius=1200, size=8){
        if(!query) return [];
        const url = `/places/kakao?query=${encodeURIComponent(query)}&lat=${lat}&lng=${lng}&radius=${radius}&size=${size}`;
        const r = await fetch(url, {headers:{'Accept':'application/json'}});
        if(!r.ok) return [];
        const arr = await r.json();
        return (Array.isArray(arr)?arr:[]).map(x => ({
            name:  x.name || x.place_name || x.title || '?',
            address: x.address || x.road_address_name || x.formattedAddress || x.addr || '',
            lat: Number(x.lat ?? x.latitude ?? x.y ?? 0),
            lng: Number(x.lng ?? x.longitude ?? x.x ?? 0),
            externalUrl: x.externalUrl || x.place_url || x.kakaoPlaceUrl || null,
            rating: x.rating ?? null,
            ratingCount: x.ratingCount ?? null
        })).filter(p => p.lat && p.lng);
    }
    function toCandidate(item, role){
        return {
            id: ideaId(item.name, item.lat, item.lng),
            role, name: item.name, address: item.address || '',
            lat: item.lat, lng: item.lng,
            externalUrl: item.externalUrl || null,
            rating: item.rating ?? null,
            ratingCount: item.ratingCount ?? null
        };
    }

    /* 점수/셔플 */
    function seededShuffle(arr, seed){ let s=seed>>>0,a=1664525,c=1013904223,m=2**32,out=arr.slice(); for(let i=out.length-1;i>0;i--){ s=(a*s+c)%m; const j=s%(i+1); [out[i],out[j]]=[out[j],out[i]];} return out;}
    const W={ rating:5.0, count:1.2, distCoef:0.01, tagBonus:2.0 }; const DEFAULT_RATING=3.9;
    function haversine(a,b,c,d){const R=6371000,dL=(c-a)*Math.PI/180,dG=(d-b)*Math.PI/180;const x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)**2;return 2*R*Math.asin(Math.sqrt(x));}
    function normalizeName(n){return String(n||'').toLowerCase().replace(/\s+/g,'').replace(/[^\p{Letter}\p{Number}]/gu,'');}
    function placeKey(p){return `${normalizeName(p.name)}|${p.lat.toFixed(6)}|${p.lng.toFixed(6)}`;}
    function mergeByKey(list){const map={}; for(const p of list){const k=placeKey(p); if(!map[k]) map[k]={...p,_tags:new Set(p._tags||[])}; else{const b=map[k]; if(!b.address&&p.address)b.address=p.address; if(!b.externalUrl&&p.externalUrl)b.externalUrl=p.externalUrl; b.rating=b.rating??p.rating??null; b.ratingCount=b.ratingCount??p.ratingCount??null; for(const t of (p._tags||[])) b._tags.add(t);} } return Object.values(map).map(x=>({...x,_tags:Array.from(x._tags||[])}));}
    function scorePlace(p,lat,lng){const dist=haversine(lat,lng,p.lat,p.lng); const r=p.rating!=null?Number(p.rating):DEFAULT_RATING; const c=Math.max(0,Number(p.ratingCount||0)); const tagHits=(p._tags&&p._tags.length)?p._tags.length:0; const score=-W.distCoef*dist+W.rating*r+W.count*Math.log(1+c)+W.tagBonus*tagHits; return {score,dist};}
    function pickTopScored(list,K,seed){ if(list.length<=K) return list; const pool=Math.min(list.length,K*2); const sorted=list.slice().sort((a,b)=>b._score-a._score||a._dist-b._dist); const top=sorted.slice(0,pool); return seededShuffle(top,seed).slice(0,K);}

    function inferIntentFromTags(tags){
        const mains=['볼거리','놀거리','쉼자리','먹을거리'];
        let whatMain=mains.find(m=>tags.includes(m))||'볼거리';
        if(!mains.some(m=>tags.includes(m))){
            if(tags.some(t=>['자연','산책로'].includes(t))) whatMain='쉼자리';
            else if(tags.some(t=>['지역문화','전시','시장','명소','축제'].includes(t))) whatMain='볼거리';
            else if(tags.some(t=>['점심식사','저녁식사','브런치','커피','디저트'].includes(t))) whatMain='먹을거리';
        }
        let cuisineQuery='맛집 OR 식당'; if(tags.includes('브런치')) cuisineQuery='브런치 카페';
        let finish='술집'; if(tags.includes('커피')) finish='카페'; else if(tags.includes('디저트')) finish='디저트'; else if(tags.includes('산책로')||tags.includes('자연')) finish='산책';
        const midTags=tags.filter(t=>ACTIVITY_TAGS.has(t));
        return {whatMain,cuisineQuery,finish,midTags};
    }

    /* AI 호출/렌더 */
    let EXCLUDE_IDS=[]; let LAST_RENDER=null;

    async function fetchIdeasByAI(seed=Date.now()){
        const venue=await resolveVenue(); const originLat=venue.lat, originLng=venue.lng;
        const companion=pickedSingle('companions')||'연인';
        const mobility=pickedSingle('mobility')||'도보';
        const tags=pickedTags();
        const {whatMain,cuisineQuery,finish,midTags}=inferIntentFromTags(tags);

        const radiusByMob = { '도보': 1200, '자전거': 2500, '대중교통': 4000, '차': 6000 };
        const radius = radiusByMob[mobility] || 1200;

        const actualMidTags=midTags.length?midTags:(whatMain==='쉼자리'?['산책로','자연']:(whatMain==='볼거리'?['지역문화','전시','명소']:[]));
        const midGroups = await Promise.all(
            actualMidTags
                .filter(t => TAG_TO_QUERY[t])
                .map(t => searchCandidates(TAG_TO_QUERY[t], originLat, originLng, radius, 5)
                    .then(arr => arr.map(x=>({...x,_tags:[t]}))))
        );
        const midTagged=midGroups.flat();

        const rRaw = await searchCandidates(cuisineQuery, originLat, originLng, radius, 16);
        const fQuery=(finish==='카페')?'카페':(finish==='디저트')?'디저트 카페 OR 베이커리':(finish==='산책')?'공원 OR 산책로':'술집';
        const fRaw = await searchCandidates(fQuery,        originLat, originLng, radius, 16);

        const mids=mergeByKey(midTagged), rests=mergeByKey(rRaw), fins=mergeByKey(fRaw);
        for(const p of mids){const s=scorePlace(p,originLat,originLng); p._score=s.score; p._dist=s.dist;}
        for(const p of rests){const s=scorePlace(p,originLat,originLng); p._score=s.score; p._dist=s.dist;}
        for(const p of fins){const s=scorePlace(p,originLat,originLng); p._score=s.score; p._dist=s.dist;}

        const midPicked=pickTopScored(mids,12,seed).map(x=>toCandidate(x,'activity'));
        const restPicked=pickTopScored(rests,10,seed).map(x=>toCandidate(x,'restaurant'));
        const finRole=(finish==='카페')?'cafe':(finish==='디저트')?'dessert':(finish==='산책')?'activity':'bar';
        const finPicked=pickTopScored(fins,10,seed).map(x=>toCandidate(x,finRole));

        const body={ companion, mobility,
            startName:venue.name, startLat:originLat, startLng:originLng,
            cuisine:cuisineQuery, finish, what:whatMain,
            tags, seed:String(seed),
            restaurants:restPicked, mid:midPicked, finals:finPicked,
            excludeIds:EXCLUDE_IDS };

        const resp=await fetch('/ai/plan',{
            method:'POST',
            headers:{'Content-Type':'application/json','Accept':'application/json'},
            credentials:'include',
            body:JSON.stringify(body)
        });
        if(!resp.ok){ const text=await resp.text().catch(()=> ''); throw new Error(`AI 서버 오류 ${resp.status}${text?` · ${text}`:''}`); }
        return { ideas: await resp.json(), ctx:{companion,mobility,tags,start:venue} };
    }

    function icon(role){ return role==='restaurant'?'🍽️':role==='bar'?'🍷':role==='cafe'?'☕':role==='dessert'?'🍰':'🎳'; }
    const star=v=> (v==null) ? '' : '★'.repeat(Math.round(v));
    function setLoading(on){ document.getElementById('loading').classList.toggle('active', on); }
    function showErr(m){ const e=document.getElementById('err'); e.textContent=m; e.style.display='block'; }
    function clearErr(){ const e=document.getElementById('err'); e.textContent=''; e.style.display='none'; }

    function renderCard(role, s, label){
        const el = document.createElement('div');
        el.className = 'card';

        let dispName = s.name && s.name !== '?' ? s.name : '';
        let lat = s.lat, lng = s.lng;

        if(!dispName){
            const p = s.id ? parseIdeaId(s.id) : null;
            if(p){ dispName = p.name || dispName; lat = lat || p.lat; lng = lng || p.lng; }
        }
        if(!dispName){
            const k = parseKakaoToLink(s.mapLink);
            if(k){ dispName = k.name || dispName; lat = lat || k.lat; lng = lng || k.lng; }
        }
        if(!dispName) dispName = '장소';

        let url  = s.externalUrl || s.mapLink;
        if(!url && dispName && lat && lng){
            url = `https://map.kakao.com/link/to/${encodeURIComponent(dispName)},${lat},${lng}`;
        }

        const rating = (s.rating!=null) ? Number(s.rating) : null;
        const ratingTxt = (rating!=null) ? `평점 ${rating.toFixed ? rating.toFixed(1) : rating} (${s.ratingCount||0})` : '';

        el.innerHTML = `
      <div class="icon">${icon(role)}</div>
      <div>
        <div class="title"><span class="label-dot">${label||''}</span><span>${dispName}</span></div>
        <div class="sub">${s.address || ''}</div>
        <div class="stars">${rating!=null ? star(rating) : ''} ${ratingTxt}</div>
      </div>
      <div class="link"><a href="${url||'#'}" target="_blank" rel="noopener">카카오 길찾기</a></div>
    `;
        return el;
    }

    function renderIdeasAndRemember(resp){
        const ideas=resp.ideas, ctx=resp.ctx;
        const result=document.getElementById('result');
        const cards=document.getElementById('cards');
        const sum=document.getElementById('summary');

        result.classList.add('active'); cards.innerHTML='';

        const plans=ideas.plans||[]; const singles=ideas.singles||[];
        if(!plans.length){ sum.textContent='추천 코스를 찾지 못했습니다.'; return; }

        const plan=plans[0];
        const roleOrder={activity:1, restaurant:2, cafe:3, dessert:3, bar:3};
        let steps=(plan.steps||[]).filter(s=>s.role!=='start').sort((a,b)=>(roleOrder[a.role]||9)-(roleOrder[b.role]||9));

        const key=p=>`${p.name}|${p.lat?.toFixed?.(6)}|${p.lng?.toFixed?.(6)}`;
        const seen=new Set(steps.map(key));
        for(const s of singles){ if(steps.length>=4) break; if(!seen.has(key(s))){ steps.push(s); seen.add(key(s)); } }
        steps=steps.slice(0,4);

        EXCLUDE_IDS = steps.map(s => s.id || ideaId(s.name||'장소', s.lat||0, s.lng||0));

        LAST_RENDER={ steps,
            totalTravelMinutes: plan.totalTravelMinutes||0,
            explain: plan.explain || '',
            companion: ctx.companion, mobility: ctx.mobility,
            startName: ctx.start.name, startLat: ctx.start.lat, startLng: ctx.start.lng,
            tags: ctx.tags };

        cards.insertAdjacentHTML('beforeend','<div class="section-title">추천 코스</div>');
        const box=document.createElement('div'); box.className='course';
        box.innerHTML=`<div class="course-head">오늘의 루트 · 이동 ${plan.totalTravelMinutes||0}분</div><div class="course-desc">${plan.explain||''}</div>`;
        cards.appendChild(box);
        ['A','B','C','D'].slice(0,steps.length).forEach((L,i)=>box.appendChild(renderCard(steps[i].role, steps[i], L)));
        sum.textContent=`장소 ${steps.length}곳으로 구성된 코스입니다.`;
        window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
    }

    /* 빌더 버튼 */
    document.getElementById('goBtn').addEventListener('click', async ()=>{
        clearErr(); setLoading(true); document.getElementById('result').classList.remove('active');
        try{ renderIdeasAndRemember(await fetchIdeasByAI(Date.now())); }
        catch(e){ showErr(e.message || '추천 중 오류가 발생했습니다.'); }
        finally{ setLoading(false); }
    });
    document.getElementById('rerollBtn').addEventListener('click', async ()=>{
        clearErr(); setLoading(true);
        try{ renderIdeasAndRemember(await fetchIdeasByAI(Date.now())); }
        catch(e){ showErr(e.message || '다시 돌리기 중 오류가 발생했습니다.'); }
        finally{ setLoading(false); }
    });

    document.getElementById('saveBtn').addEventListener('click', async ()=>{
        if(!LAST_RENDER){ alert('먼저 코스를 생성해 주세요!'); return; }
        const body = {
            title: new Date().toISOString().slice(0,10),
            companion: LAST_RENDER.companion, mobility: LAST_RENDER.mobility,
            startName: LAST_RENDER.startName, startLat: LAST_RENDER.startLat, startLng: LAST_RENDER.startLng,
            tags: LAST_RENDER.tags,
            totalTravelMinutes: LAST_RENDER.totalTravelMinutes, explain: LAST_RENDER.explain,
            steps: LAST_RENDER.steps.map((s,i)=>({ label:['A','B','C','D'][i], id:ideaId(s.name,s.lat,s.lng),
                role:s.role, name:s.name, address:s.address, lat:s.lat, lng:s.lng,
                externalUrl:s.externalUrl, mapLink:s.mapLink, rating:s.rating, ratingCount:s.ratingCount }))
        };
        try{
            const resp=await fetchWithAuth(API_BASE,{method:'POST',body:JSON.stringify(body)});
            if(!resp.ok) throw new Error('저장 실패');
            const saved=await resp.json();
            alert('저장 완료! (id: '+saved.id+')');
            const badge = document.getElementById('authBadge');
            if (badge) { badge.textContent = '연동됨'; badge.style.display = ''; }
        }catch(e){ console.error(e); alert('저장 중 오류가 발생했어요.'); }
    });

    /* 목록/상세 */
    async function openSavedList(){
        showView('list');
        const box=document.getElementById('listBox'); box.innerHTML='로딩 중…';
        try{
            const res = await fetchWithAuth(API_BASE);
            const rows = await res.json();
            if(!rows.length){ box.innerHTML='<div style="color:#999">아직 저장된 코스가 없어요.</div>'; return; }
            box.innerHTML='';
            rows.forEach(r=>{
                const div=document.createElement('div'); div.className='list-item';
                const left=document.createElement('div');
                const right=document.createElement('div');
                left.innerHTML=`
          <div class="list-title">${r.title||'나의 루트'}</div>
          <div style="margin-top:6px;">
            <span class="pill">${r.startName}</span>
            <span class="pill">${r.companion||'-'}</span>
            <span class="pill">${r.mobility||'-'}</span>
            ${(r.tags||[]).slice(0,3).map(t=>`<span class="pill">${t}</span>`).join('')}
          </div>`;
                right.innerHTML=`<span style="color:#999;font-size:12px">${(r.createdAt||'').slice(0,10)}</span>`;
                div.appendChild(left); div.appendChild(right);
                div.addEventListener('click',()=>openSavedDetail(r.id));
                box.appendChild(div);
            });
        }catch(e){ box.innerHTML='<div style="color:#b00">목록을 불러오지 못했어요.</div>'; }
    }

    async function openSavedDetail(id){
        showView('detail');
        const title=document.getElementById('detailTitle');
        const meta=document.getElementById('detailMeta');
        const cards=document.getElementById('detailCards');
        title.textContent='저장한 코스'; meta.textContent='불러오는 중…'; cards.innerHTML='';

        try{
            const r = await fetchWithAuth(`${API_BASE}/${encodeURIComponent(id)}`).then(x=>x.json());
            title.textContent=r.title || '저장한 코스';
            meta.textContent = `${(r.createdAt||'').slice(0,10)} · ${r.startName} · ${r.companion||'-'} · ${r.mobility||'-'} · ${(r.tags||[]).join(', ')}`;
            cards.innerHTML='';
            const box=document.createElement('div'); box.className='course';
            box.innerHTML=`<div class="course-head">이동 ${r.totalTravelMinutes||0}분</div><div class="course-desc">${r.explain||''}</div>`;
            cards.appendChild(box);
            (r.steps||[]).forEach(s=>box.appendChild(renderCard(s.role, s, s.label)));

            const url=new URL(location.href); url.searchParams.set('savedId', id); history.replaceState({},'',url.toString());

            document.getElementById('detailDelete').onclick=async ()=>{
                if(!confirm('정말 삭제할까요?')) return;
                const del=await fetchWithAuth(`${API_BASE}/${encodeURIComponent(id)}`,{method:'DELETE'});
                if(del.ok){ alert('삭제했어요.'); openSavedList(); }
                else{ alert('삭제에 실패했어요.'); }
            };
            document.getElementById('detailShare').onclick=async ()=>{
                try{ await navigator.clipboard.writeText(location.href); alert('링크를 복사했어요!'); }
                catch(_){ prompt('이 링크를 복사하세요', location.href); }
            };
        }catch(e){
            meta.textContent='불러오지 못했어요.'; console.error(e);
        }
    }

    /* 헤더/툴바 버튼 */
    document.getElementById('openListBtn').addEventListener('click', openSavedList);
    document.getElementById('backToBuilder').addEventListener('click', ()=>showView('builder'));
    document.getElementById('refreshList').addEventListener('click', openSavedList);
    document.getElementById('detailBack').addEventListener('click', openSavedList);

    /* 초기: 쿼리로 바로 상세 열기 */
    (function boot(){
        const qs=new URLSearchParams(location.search);
        const savedId=qs.get('savedId');
        if(savedId){ openSavedDetail(savedId); }
        else{ showView('builder'); }
    })();
</script>
</body>
</html>
