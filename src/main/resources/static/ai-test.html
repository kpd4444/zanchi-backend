<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>í•«í”ŒÂ·ë£¨íŠ¸ â€“ ë°ì´íŠ¸ ê²½ë¡œ ì¶”ì²œ (AI)</title>
    <style>
        :root{--bg:#fff7f2;--surface:#fff;--brand:#ff7e43;--brand-ink:#fff;--ink:#2a2a2a;--muted:#7b7b7b;--chip:#ffe7da;--shadow:0 10px 30px rgba(0,0,0,.08);--r:24px}
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;background:var(--bg);color:var(--ink);display:flex;justify-content:center}
        .app{max-width:520px;width:100%;min-height:100dvh;padding:20px}
        header{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 18px}
        .logo{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--brand)}
        .logo-dot{width:10px;height:10px;background:var(--brand);border-radius:50%;box-shadow:14px 0 0 var(--brand),28px 0 0 var(--brand);margin-right:6px}
        .hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px 12px 8px}
        .hero p{margin:0;text-align:center;color:var(--muted);line-height:1.5}
        .tiger{width:120px;height:120px;border-radius:28px;background:#fff;border:8px solid #ffd6bd;position:relative;box-shadow:var(--shadow);margin-top:6px}
        .tiger:before,.tiger:after{content:"";position:absolute;background:#ffd3b3;width:28px;height:28px;border-radius:50%}
        .tiger:before{left:-6px;bottom:10px}.tiger:after{right:-6px;bottom:10px}
        .book{position:absolute;left:50%;bottom:-2px;transform:translateX(-50%);width:120px;height:60px;background:var(--brand);border-radius:10px 10px 18px 18px;box-shadow:0 8px 20px rgba(255,126,67,.35)}
        .panel{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin:14px 0}
        .q{font-weight:800;margin:2px 0 12px}
        .chips{display:flex;flex-wrap:wrap;gap:10px}
        .chip{padding:12px 14px;border-radius:999px;background:var(--chip);border:1px solid transparent;cursor:pointer;font-weight:700;color:var(--ink);transition:all .15s ease}
        .chip[aria-pressed="true"]{background:var(--brand);color:var(--brand-ink);box-shadow:0 6px 16px rgba(242,106,45,.28)}
        .chip:active{transform:translateY(1px)}
        .cta{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center}
        .btn{border:0;border-radius:16px;padding:14px 18px;font-weight:800;cursor:pointer;background:var(--brand);color:#fff;box-shadow:0 10px 24px rgba(242,106,45,.35);width:100%}
        .btn:active{transform:translateY(1px)}
        .loading{display:none;align-items:center;gap:8px;color:var(--muted);padding:6px 4px}
        .loading.active{display:flex}
        .err{display:none;background:#fff1f1;border:1px solid #ffd6d6;color:#a80000;padding:12px;border-radius:12px;margin-top:10px}
        .result{margin-top:14px;display:none}
        .result.active{display:block}
        .summary{color:#7b7b7b;margin:6px 2px 10px}
        .section-title{font-weight:900;margin:10px 6px 6px}
        .card{background:var(--surface);border-radius:18px;box-shadow:var(--shadow);padding:14px;margin:10px 0;display:grid;grid-template-columns:48px 1fr auto;gap:12px;align-items:center}
        .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;background:#fff3ec}
        .title{font-weight:800}
        .sub{color:var(--muted);font-size:13px}
        .stars{color:#f7b500;white-space:nowrap}
        .link a{display:inline-block;text-decoration:none;color:#f26a2d;font-weight:800;padding:10px 12px;border-radius:12px;border:1px solid #ffe0cf;background:#fff}
        .course{padding:12px;border-radius:16px;background:var(--surface);box-shadow:var(--shadow);margin:12px 0}
        .course-head{font-weight:900;margin-bottom:6px}
        .course-desc{color:#6e6e6e;margin:4px 0 6px}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="logo"><span class="logo-dot"></span>í•«í”ŒÂ·ë£¨íŠ¸</div>
        <div style="color:#999;font-size:12px">AI</div>
    </header>

    <section class="hero">
        <div class="tiger"><div class="book"></div></div>
        <p>ëˆ„êµ¬ë‘ ì „ì‹œÂ·ê³µì—° ë³´ëŸ¬ì™”ë‚˜ìš”?<br/>ì–´ë–¤ ë¶„ìœ„ê¸°ë¥¼ ì›í•˜ë‚˜ìš”?</p>
    </section>

    <!-- 1~6. ì„ íƒ UI (ê¸°ì¡´ ê·¸ëŒ€ë¡œ) -->
    <section class="panel">
        <div class="q">â‘  ëˆ„êµ¬ë‘ ì™”ë‚˜ìš”?</div>
        <div class="chips" id="companions">
            <button class="chip" data-value="ì—°ì¸" aria-pressed="true">ì—°ì¸</button>
            <button class="chip" data-value="ì¹œêµ¬">ì¹œêµ¬</button>
            <button class="chip" data-value="í˜¼ì">í˜¼ì</button>
            <button class="chip" data-value="ê°€ì¡±">ê°€ì¡±</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">â‘¡ ì–´ë–»ê²Œ ì´ë™í•˜ë‚˜ìš”?</div>
        <div class="chips" id="mobility">
            <button class="chip" data-value="ë„ë³´" aria-pressed="true">ë„ë³´</button>
            <button class="chip" data-value="ìì „ê±°">ìì „ê±°</button>
            <button class="chip" data-value="ëŒ€ì¤‘êµí†µ">ëŒ€ì¤‘êµí†µ</button>
            <button class="chip" data-value="ì°¨">ì°¨</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">â‘¢ ì–´ë””ë¥¼ ê°€ê³ ì‹¶ë‚˜ìš”? (ì¤‘ê°„)</div>
        <div class="chips" id="what">
            <button class="chip" data-value="ë³¼ê±°ë¦¬" aria-pressed="true">ë³¼ê±°ë¦¬</button>
            <button class="chip" data-value="ë†€ê±°ë¦¬">ë†€ê±°ë¦¬</button>
            <button class="chip" data-value="ì‰¼ìë¦¬">ì‰¼ìë¦¬</button>
            <button class="chip" data-value="ë¨¹ì„ê±°ë¦¬">ë¨¹ì„ê±°ë¦¬</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">â‘£ ì–´ë–¤ ìŒì‹ì´ ì¢‹ì•„ìš”?</div>
        <div class="chips" id="cuisine">
            <button class="chip" data-value="í•œì‹">í•œì‹</button>
            <button class="chip" data-value="ì–‘ì‹" aria-pressed="true">ì–‘ì‹</button>
            <button class="chip" data-value="ì¤‘ì‹">ì¤‘ì‹</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">â‘¤ ë§ˆë¬´ë¦¬ëŠ” ì–´ë””ë¡œ ê°ˆê¹Œìš”?</div>
        <div class="chips" id="finish">
            <button class="chip" data-value="ìˆ ì§‘" aria-pressed="true">ìˆ ì§‘</button>
            <button class="chip" data-value="ì¹´í˜">ì¹´í˜</button>
            <button class="chip" data-value="ë””ì €íŠ¸">ë””ì €íŠ¸</button>
            <button class="chip" data-value="ë³¼ë§">ë³¼ë§</button>
            <button class="chip" data-value="ì‚°ì±…">ì‚°ì±…</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">â‘¥ ì–´ë”” ê·¼ì²˜ë¡œ ì¡ì„ê¹Œìš”?</div>
        <div class="chips" id="venue">
            <button class="chip" data-value="ë–¼ì•„ëœ¨ë¥´ë‹¤ë½ì†Œê·¹ì¥" aria-pressed="true">ë–¼ì•„ëœ¨ë¥´ë‹¤ë½ì†Œê·¹ì¥</button>
            <button class="chip" data-value="ì‹ í¬ ì•„íŠ¸í™€">ì‹ í¬ ì•„íŠ¸í™€</button>
        </div>
        <div class="cta"><button class="btn" id="goBtn">ì½”ìŠ¤ ì¶”ì²œë°›ê¸°</button></div>
        <div class="loading" id="loading">â³ ì¶”ì²œ ì½”ìŠ¤ë¥¼ ê³„ì‚° ì¤‘â€¦</div>
        <div class="err" id="err"></div>
    </section>

    <!-- ê²°ê³¼ -->
    <section class="result" id="result">
        <div class="summary" id="summary"></div>
        <div id="cards"></div>
    </section>
</div>

<script>
    /* ---------------- ê³µí†µ ì…‹ì—… ---------------- */
    function setupChips(id, single=true){
        const box=document.getElementById(id);
        box.addEventListener('click',(e)=>{
            const b=e.target.closest('.chip'); if(!b) return;
            if(single){ box.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false')); }
            b.setAttribute('aria-pressed', String(b.getAttribute('aria-pressed')!=='true'));
        });
    }
    ['companions','mobility','what','cuisine','finish','venue'].forEach(id=>setupChips(id));
    const picked = id => (document.querySelector(`#${id} .chip[aria-pressed="true"]`)||{}).dataset?.value || null;

    // ì‹œì‘ì§€ì  ì¢Œí‘œ(ë°±ì—…)
    const VENUES = {
        "ë–¼ì•„ëœ¨ë¥´ë‹¤ë½ì†Œê·¹ì¥": {lat:37.473108,lng:126.625204,addr:"ì¸ì²œ ì¤‘êµ¬ ì‹ í¬ë¡œ27ë²ˆê¸¸ 3 3ì¸µ"},
        "ì‹ í¬ ì•„íŠ¸í™€": {lat:37.47344,lng:126.62465,addr:"ì¸ì²œ ì¤‘êµ¬ ì‹ í¬ë¡œ31ë²ˆê¸¸ 6"}
    };

    async function resolveVenue(){
        const name = picked('venue') || 'ë–¼ì•„ëœ¨ë¥´ë‹¤ë½ì†Œê·¹ì¥';
        if (VENUES[name]) return { name, lat: VENUES[name].lat, lng: VENUES[name].lng };
        // ì¹´ì¹´ì˜¤ í”„ë¡ì‹œ í†µí•´ ì¢Œí‘œ ì°¾ê¸° (ì„œë²„ì— /places/kakao ì¡´ì¬ ê°€ì •)
        try{
            const r = await fetch(`/places/kakao?query=${encodeURIComponent(name)}&size=1`, {headers:{'Accept':'application/json'}});
            if(r.ok){
                const arr = await r.json();
                if(Array.isArray(arr) && arr[0]) return { name, lat: arr[0].lat, lng: arr[0].lng };
            }
        }catch(_){}
        return { name, lat: 37.5665, lng: 126.9780 };
    }

    /* ---------------- ì¹´í…Œê³ ë¦¬ â†’ ì§ˆì˜/ì—­í•  ë§¤í•‘ ---------------- */
    function mapWhatToQuery(what){
        switch(what){
            case 'ë³¼ê±°ë¦¬': return 'ì „ì‹œ OR ë¯¸ìˆ ê´€ OR ë°•ë¬¼ê´€ OR ê´€ê´‘ëª…ì†Œ';
            case 'ë†€ê±°ë¦¬': return 'ì˜¤ë½ì‹¤ OR ë³´ë“œê²Œì„ OR ë£¸ì¹´í˜ OR ì²´í—˜';
            case 'ì‰¼ìë¦¬': return 'ê³µì› OR ì‚°ì±…ë¡œ OR ì „ë§ëŒ€';
            default: return null;
        }
    }
    function mapFinishToQuery(finish){
        switch(finish){
            case 'ì¹´í˜': return 'ì¹´í˜';
            case 'ë””ì €íŠ¸': return 'ë””ì €íŠ¸ ì¹´í˜ OR ë² ì´ì»¤ë¦¬';
            case 'ë³¼ë§': return 'ë³¼ë§ì¥';
            case 'ì‚°ì±…': return 'ê³µì› OR ì‚°ì±…ë¡œ';
            default: return 'ìˆ ì§‘';
        }
    }
    function mapFinishRole(finish){
        switch(finish){
            case 'ì¹´í˜': return 'cafe';
            case 'ë””ì €íŠ¸': return 'dessert';
            case 'ë³¼ë§':
            case 'ì‚°ì±…': return 'activity';
            default: return 'bar';
        }
    }

    /* ---------------- í›„ë³´ ìˆ˜ì§‘ (ì¹´ì¹´ì˜¤ í”„ë¡ì‹œ í™œìš©) ---------------- */
    async function searchCandidates(query, lat, lng, radius=1200, size=8){
        if(!query) return [];
        const url = `/places/kakao?query=${encodeURIComponent(query)}&lat=${lat}&lng=${lng}&radius=${radius}&size=${size}`;
        const r = await fetch(url, {headers:{'Accept':'application/json'}});
        if(!r.ok) return [];
        const arr = await r.json();
        // ë°±ì—”ë“œ í”„ë¡ì‹œ ê²°ê³¼ í•„ë“œ ì´ë¦„ì— ìœ ì—°í•˜ê²Œ ëŒ€ì‘
        return (Array.isArray(arr)?arr:[]).map(x => ({
            name:  x.name || x.place_name || x.title || '?',
            address: x.address || x.road_address_name || x.formattedAddress || x.addr || '',
            lat: Number(x.lat ?? x.latitude ?? x.y ?? 0),
            lng: Number(x.lng ?? x.longitude ?? x.x ?? 0),
            externalUrl: x.externalUrl || x.place_url || x.kakaoPlaceUrl || null,
            rating: x.rating ?? null,
            ratingCount: x.ratingCount ?? null
        })).filter(p => p.lat && p.lng);
    }

    function toCandidate(item, role){
        return {
            role, // "restaurant" | "activity" | "bar" | "cafe" | "dessert" â€¦
            name: item.name,
            address: item.address || '',
            lat: item.lat,
            lng: item.lng,
            externalUrl: item.externalUrl || null,
            rating: item.rating ?? null,
            ratingCount: item.ratingCount ?? null
        };
    }

    /* ---------------- AI í˜¸ì¶œ ---------------- */
    async function fetchIdeasByAI(){
        const venue = await resolveVenue();
        const companion = picked('companions') || 'ì—°ì¸';
        const mobility  = picked('mobility') || 'ë„ë³´';
        const cuisine   = picked('cuisine') || 'ì–‘ì‹';
        const what      = picked('what')    || 'ë¨¹ì„ê±°ë¦¬';
        const finish    = picked('finish')  || 'ìˆ ì§‘';

        // í›„ë³´ ìˆ˜ì§‘
        const [rList, mList, fList] = await Promise.all([
            searchCandidates(cuisine, venue.lat, venue.lng, 1200, 8),
            what !== 'ë¨¹ì„ê±°ë¦¬' ? searchCandidates(mapWhatToQuery(what), venue.lat, venue.lng, 1200, 8) : Promise.resolve([]),
            searchCandidates(mapFinishToQuery(finish), venue.lat, venue.lng, 1200, 8)
        ]);

        // ì—­í•  íƒœê¹…í•´ì„œ DTOë¡œ ë³€í™˜
        const restaurants = rList.map(x => toCandidate(x, 'restaurant'));
        const mid         = mList.map(x => toCandidate(x, 'activity'));
        const finals      = fList.map(x => toCandidate(x, mapFinishRole(finish)));

        // AIë¡œ í”Œëœ ìƒì„± ìš”ì²­
        const body = {
            companion, mobility,
            startName: venue.name, startLat: venue.lat, startLng: venue.lng,
            cuisine, finish, what,
            restaurants, mid, finals
        };

        const resp = await fetch('/ai/plan', {
            method: 'POST',
            headers: {'Content-Type':'application/json', 'Accept':'application/json'},
            body: JSON.stringify(body)
        });
        if(!resp.ok){
            const text = await resp.text().catch(()=> '');
            throw new Error(`AI ì„œë²„ ì˜¤ë¥˜ ${resp.status}${text?` Â· ${text}`:''}`);
        }
        return resp.json();
    }

    /* ---------------- ë Œë”ë§ ---------------- */
    function icon(role){
        switch(role){
            case 'start': return 'ğŸ¬';
            case 'restaurant': return 'ğŸ½ï¸';
            case 'bar': return 'ğŸ·';
            case 'cafe': return 'â˜•';
            case 'dessert': return 'ğŸ°';
            default: return 'ğŸ³';
        }
    }
    const star = v => (v==null) ? '' : 'â˜…'.repeat(Math.round(v));
    function setLoading(on){ document.getElementById('loading').classList.toggle('active', on); }
    function showErr(m){ const e=document.getElementById('err'); e.textContent=m; e.style.display='block'; }
    function clearErr(){ const e=document.getElementById('err'); e.textContent=''; e.style.display='none'; }

    function renderIdeas(ideas){
        const result = document.getElementById('result');
        const cards  = document.getElementById('cards');
        const sum    = document.getElementById('summary');

        result.classList.add('active');
        cards.innerHTML = '';

        // ê·¼ì²˜ í•«í”Œ
        const singles = ideas.singles || [];
        if(singles.length){
            cards.insertAdjacentHTML('beforeend','<div class="section-title">ê·¼ì²˜ í•«í”Œ</div>');
            singles.forEach(p => cards.appendChild(renderCard(p.role || 'activity', p)));
        }

        // ì¶”ì²œ ì½”ìŠ¤
        const plans = ideas.plans || [];
        if(plans.length){
            cards.insertAdjacentHTML('beforeend','<div class="section-title">ì¶”ì²œ ì½”ìŠ¤</div>');
            plans.forEach((plan, idx) => {
                const box = document.createElement('div');
                box.className = 'course';
                box.innerHTML = `
          <div class="course-head">í”Œëœ ${idx+1} Â· ì´ë™ ${plan.totalTravelMinutes||0}ë¶„</div>
          <div class="course-desc">${plan.explain || ''}</div>
        `;
                (plan.steps||[]).forEach(st => box.appendChild(renderCard(st.role, st)));
                cards.appendChild(box);
            });
            sum.textContent = `ì´ ì˜ˆìƒ ì´ë™ì‹œê°„(ìµœì  ì½”ìŠ¤ ê¸°ì¤€) Â· ì•½ ${plans[0].totalTravelMinutes||0}ë¶„`;
        }else{
            sum.textContent = 'ì¶”ì²œ ì½”ìŠ¤ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
        }

        window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
    }

    function renderCard(role, s){
        const el = document.createElement('div');
        el.className = 'card';
        const rating = (s.rating!=null) ? Number(s.rating) : null;
        const ratingTxt = (rating!=null) ? `í‰ì  ${rating.toFixed ? rating.toFixed(1) : rating} (${s.ratingCount||0})` : '';
        const name = s.name ?? '?';
        const addr = s.address || '';
        const url  = s.externalUrl || s.mapLink || '#';
        el.innerHTML = `
      <div class="icon">${icon(role)}</div>
      <div>
        <div class="title">${name}</div>
        <div class="sub">${addr}</div>
        <div class="stars">${rating!=null ? star(rating) : ''} ${ratingTxt}</div>
      </div>
      <div class="link"><a href="${url}" target="_blank" rel="noopener">ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸°</a></div>
    `;
        return el;
    }

    /* ---------------- ë²„íŠ¼ ---------------- */
    document.getElementById('goBtn').addEventListener('click', async ()=>{
        clearErr(); setLoading(true); document.getElementById('result').classList.remove('active');
        try{
            const ideas = await fetchIdeasByAI();
            renderIdeas(ideas);
        }catch(e){
            console.error(e);
            showErr(e.message || 'ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ /date/ideas ë¡œ í´ë°± í˜¸ì¶œ ê°€ëŠ¥
        }finally{
            setLoading(false);
        }
    });
</script>
</body>
</html>
