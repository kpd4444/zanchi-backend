<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>핫플·루트 – 데이트 경로 추천 (AI)</title>
    <style>
        :root{--bg:#fff7f2;--surface:#fff;--brand:#ff7e43;--brand-ink:#fff;--ink:#2a2a2a;--muted:#7b7b7b;--chip:#ffe7da;--shadow:0 10px 30px rgba(0,0,0,.08);--r:24px}
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;background:var(--bg);color:var(--ink);display:flex;justify-content:center}
        .app{max-width:520px;width:100%;min-height:100dvh;padding:20px}
        header{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 18px}
        .logo{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--brand)}
        .logo-dot{width:10px;height:10px;background:var(--brand);border-radius:50%;box-shadow:14px 0 0 var(--brand),28px 0 0 var(--brand);margin-right:6px}
        .hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px 12px 8px}
        .hero p{margin:0;text-align:center;color:var(--muted);line-height:1.5}
        .tiger{width:120px;height:120px;border-radius:28px;background:#fff;border:8px solid #ffd6bd;position:relative;box-shadow:var(--shadow);margin-top:6px}
        .tiger:before,.tiger:after{content:"";position:absolute;background:#ffd3b3;width:28px;height:28px;border-radius:50%}
        .tiger:before{left:-6px;bottom:10px}.tiger:after{right:-6px;bottom:10px}
        .book{position:absolute;left:50%;bottom:-2px;transform:translateX(-50%);width:120px;height:60px;background:var(--brand);border-radius:10px 10px 18px 18px;box-shadow:0 8px 20px rgba(255,126,67,.35)}
        .panel{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin:14px 0}
        .q{font-weight:800;margin:2px 0 12px}
        .chips{display:flex;flex-wrap:wrap;gap:10px}
        .chip{padding:12px 14px;border-radius:999px;background:var(--chip);border:1px solid transparent;cursor:pointer;font-weight:700;color:var(--ink);transition:all .15s ease}
        .chip[aria-pressed="true"]{background:var(--brand);color:var(--brand-ink);box-shadow:0 6px 16px rgba(242,106,45,.28)}
        .chip:active{transform:translateY(1px)}
        .cta{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center}
        .btn{border:0;border-radius:16px;padding:14px 18px;font-weight:800;cursor:pointer;background:var(--brand);color:#fff;box-shadow:0 10px 24px rgba(242,106,45,.35);width:100%}
        .btn:active{transform:translateY(1px)}
        .loading{display:none;align-items:center;gap:8px;color:var(--muted);padding:6px 4px}
        .loading.active{display:flex}
        .err{display:none;background:#fff1f1;border:1px solid #ffd6d6;color:#a80000;padding:12px;border-radius:12px;margin-top:10px}
        .result{margin-top:14px;display:none}
        .result.active{display:block}
        .summary{color:#7b7b7b;margin:6px 2px 10px}
        .section-title{font-weight:900;margin:10px 6px 6px}
        .card{background:var(--surface);border-radius:18px;box-shadow:var(--shadow);padding:14px;margin:10px 0;display:grid;grid-template-columns:48px 1fr auto;gap:12px;align-items:center}
        .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;background:#fff3ec}
        .title{font-weight:800}
        .sub{color:var(--muted);font-size:13px}
        .stars{color:#f7b500;white-space:nowrap}
        .link a{display:inline-block;text-decoration:none;color:#f26a2d;font-weight:800;padding:10px 12px;border-radius:12px;border:1px solid #ffe0cf;background:#fff}
        .course{padding:12px;border-radius:16px;background:var(--surface);box-shadow:var(--shadow);margin:12px 0}
        .course-head{font-weight:900;margin-bottom:6px}
        .course-desc{color:#6e6e6e;margin:4px 0 6px}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="logo"><span class="logo-dot"></span>핫플·루트</div>
        <div style="color:#999;font-size:12px">AI</div>
    </header>

    <section class="hero">
        <div class="tiger"><div class="book"></div></div>
        <p>누구랑 전시·공연 보러왔나요?<br/>어떤 분위기를 원하나요?</p>
    </section>

    <!-- 1~6. 선택 UI (기존 그대로) -->
    <section class="panel">
        <div class="q">① 누구랑 왔나요?</div>
        <div class="chips" id="companions">
            <button class="chip" data-value="연인" aria-pressed="true">연인</button>
            <button class="chip" data-value="친구">친구</button>
            <button class="chip" data-value="혼자">혼자</button>
            <button class="chip" data-value="가족">가족</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">② 어떻게 이동하나요?</div>
        <div class="chips" id="mobility">
            <button class="chip" data-value="도보" aria-pressed="true">도보</button>
            <button class="chip" data-value="자전거">자전거</button>
            <button class="chip" data-value="대중교통">대중교통</button>
            <button class="chip" data-value="차">차</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">③ 어디를 가고싶나요? (중간)</div>
        <div class="chips" id="what">
            <button class="chip" data-value="볼거리" aria-pressed="true">볼거리</button>
            <button class="chip" data-value="놀거리">놀거리</button>
            <button class="chip" data-value="쉼자리">쉼자리</button>
            <button class="chip" data-value="먹을거리">먹을거리</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">④ 어떤 음식이 좋아요?</div>
        <div class="chips" id="cuisine">
            <button class="chip" data-value="한식">한식</button>
            <button class="chip" data-value="양식" aria-pressed="true">양식</button>
            <button class="chip" data-value="중식">중식</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">⑤ 마무리는 어디로 갈까요?</div>
        <div class="chips" id="finish">
            <button class="chip" data-value="술집" aria-pressed="true">술집</button>
            <button class="chip" data-value="카페">카페</button>
            <button class="chip" data-value="디저트">디저트</button>
            <button class="chip" data-value="볼링">볼링</button>
            <button class="chip" data-value="산책">산책</button>
        </div>
    </section>

    <section class="panel">
        <div class="q">⑥ 어디 근처로 잡을까요?</div>
        <div class="chips" id="venue">
            <button class="chip" data-value="떼아뜨르다락소극장" aria-pressed="true">떼아뜨르다락소극장</button>
            <button class="chip" data-value="신포 아트홀">신포 아트홀</button>
        </div>
        <div class="cta"><button class="btn" id="goBtn">코스 추천받기</button></div>
        <div class="loading" id="loading">⏳ 추천 코스를 계산 중…</div>
        <div class="err" id="err"></div>
    </section>

    <!-- 결과 -->
    <section class="result" id="result">
        <div class="summary" id="summary"></div>
        <div id="cards"></div>
    </section>
</div>

<script>
    /* ---------------- 공통 셋업 ---------------- */
    function setupChips(id, single=true){
        const box=document.getElementById(id);
        box.addEventListener('click',(e)=>{
            const b=e.target.closest('.chip'); if(!b) return;
            if(single){ box.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false')); }
            b.setAttribute('aria-pressed', String(b.getAttribute('aria-pressed')!=='true'));
        });
    }
    ['companions','mobility','what','cuisine','finish','venue'].forEach(id=>setupChips(id));
    const picked = id => (document.querySelector(`#${id} .chip[aria-pressed="true"]`)||{}).dataset?.value || null;

    // 시작지점 좌표(백업)
    const VENUES = {
        "떼아뜨르다락소극장": {lat:37.473108,lng:126.625204,addr:"인천 중구 신포로27번길 3 3층"},
        "신포 아트홀": {lat:37.47344,lng:126.62465,addr:"인천 중구 신포로31번길 6"}
    };

    async function resolveVenue(){
        const name = picked('venue') || '떼아뜨르다락소극장';
        if (VENUES[name]) return { name, lat: VENUES[name].lat, lng: VENUES[name].lng };
        // 카카오 프록시 통해 좌표 찾기 (서버에 /places/kakao 존재 가정)
        try{
            const r = await fetch(`/places/kakao?query=${encodeURIComponent(name)}&size=1`, {headers:{'Accept':'application/json'}});
            if(r.ok){
                const arr = await r.json();
                if(Array.isArray(arr) && arr[0]) return { name, lat: arr[0].lat, lng: arr[0].lng };
            }
        }catch(_){}
        return { name, lat: 37.5665, lng: 126.9780 };
    }

    /* ---------------- 카테고리 → 질의/역할 매핑 ---------------- */
    function mapWhatToQuery(what){
        switch(what){
            case '볼거리': return '전시 OR 미술관 OR 박물관 OR 관광명소';
            case '놀거리': return '오락실 OR 보드게임 OR 룸카페 OR 체험';
            case '쉼자리': return '공원 OR 산책로 OR 전망대';
            default: return null;
        }
    }
    function mapFinishToQuery(finish){
        switch(finish){
            case '카페': return '카페';
            case '디저트': return '디저트 카페 OR 베이커리';
            case '볼링': return '볼링장';
            case '산책': return '공원 OR 산책로';
            default: return '술집';
        }
    }
    function mapFinishRole(finish){
        switch(finish){
            case '카페': return 'cafe';
            case '디저트': return 'dessert';
            case '볼링':
            case '산책': return 'activity';
            default: return 'bar';
        }
    }

    /* ---------------- 후보 수집 (카카오 프록시 활용) ---------------- */
    async function searchCandidates(query, lat, lng, radius=1200, size=8){
        if(!query) return [];
        const url = `/places/kakao?query=${encodeURIComponent(query)}&lat=${lat}&lng=${lng}&radius=${radius}&size=${size}`;
        const r = await fetch(url, {headers:{'Accept':'application/json'}});
        if(!r.ok) return [];
        const arr = await r.json();
        // 백엔드 프록시 결과 필드 이름에 유연하게 대응
        return (Array.isArray(arr)?arr:[]).map(x => ({
            name:  x.name || x.place_name || x.title || '?',
            address: x.address || x.road_address_name || x.formattedAddress || x.addr || '',
            lat: Number(x.lat ?? x.latitude ?? x.y ?? 0),
            lng: Number(x.lng ?? x.longitude ?? x.x ?? 0),
            externalUrl: x.externalUrl || x.place_url || x.kakaoPlaceUrl || null,
            rating: x.rating ?? null,
            ratingCount: x.ratingCount ?? null
        })).filter(p => p.lat && p.lng);
    }

    function toCandidate(item, role){
        return {
            role, // "restaurant" | "activity" | "bar" | "cafe" | "dessert" …
            name: item.name,
            address: item.address || '',
            lat: item.lat,
            lng: item.lng,
            externalUrl: item.externalUrl || null,
            rating: item.rating ?? null,
            ratingCount: item.ratingCount ?? null
        };
    }

    /* ---------------- AI 호출 ---------------- */
    async function fetchIdeasByAI(){
        const venue = await resolveVenue();
        const companion = picked('companions') || '연인';
        const mobility  = picked('mobility') || '도보';
        const cuisine   = picked('cuisine') || '양식';
        const what      = picked('what')    || '먹을거리';
        const finish    = picked('finish')  || '술집';

        // 후보 수집
        const [rList, mList, fList] = await Promise.all([
            searchCandidates(cuisine, venue.lat, venue.lng, 1200, 8),
            what !== '먹을거리' ? searchCandidates(mapWhatToQuery(what), venue.lat, venue.lng, 1200, 8) : Promise.resolve([]),
            searchCandidates(mapFinishToQuery(finish), venue.lat, venue.lng, 1200, 8)
        ]);

        // 역할 태깅해서 DTO로 변환
        const restaurants = rList.map(x => toCandidate(x, 'restaurant'));
        const mid         = mList.map(x => toCandidate(x, 'activity'));
        const finals      = fList.map(x => toCandidate(x, mapFinishRole(finish)));

        // AI로 플랜 생성 요청
        const body = {
            companion, mobility,
            startName: venue.name, startLat: venue.lat, startLng: venue.lng,
            cuisine, finish, what,
            restaurants, mid, finals
        };

        const resp = await fetch('/ai/plan', {
            method: 'POST',
            headers: {'Content-Type':'application/json', 'Accept':'application/json'},
            body: JSON.stringify(body)
        });
        if(!resp.ok){
            const text = await resp.text().catch(()=> '');
            throw new Error(`AI 서버 오류 ${resp.status}${text?` · ${text}`:''}`);
        }
        return resp.json();
    }

    /* ---------------- 렌더링 ---------------- */
    function icon(role){
        switch(role){
            case 'start': return '🎬';
            case 'restaurant': return '🍽️';
            case 'bar': return '🍷';
            case 'cafe': return '☕';
            case 'dessert': return '🍰';
            default: return '🎳';
        }
    }
    const star = v => (v==null) ? '' : '★'.repeat(Math.round(v));
    function setLoading(on){ document.getElementById('loading').classList.toggle('active', on); }
    function showErr(m){ const e=document.getElementById('err'); e.textContent=m; e.style.display='block'; }
    function clearErr(){ const e=document.getElementById('err'); e.textContent=''; e.style.display='none'; }

    function renderIdeas(ideas){
        const result = document.getElementById('result');
        const cards  = document.getElementById('cards');
        const sum    = document.getElementById('summary');

        result.classList.add('active');
        cards.innerHTML = '';

        // 근처 핫플
        const singles = ideas.singles || [];
        if(singles.length){
            cards.insertAdjacentHTML('beforeend','<div class="section-title">근처 핫플</div>');
            singles.forEach(p => cards.appendChild(renderCard(p.role || 'activity', p)));
        }

        // 추천 코스
        const plans = ideas.plans || [];
        if(plans.length){
            cards.insertAdjacentHTML('beforeend','<div class="section-title">추천 코스</div>');
            plans.forEach((plan, idx) => {
                const box = document.createElement('div');
                box.className = 'course';
                box.innerHTML = `
          <div class="course-head">플랜 ${idx+1} · 이동 ${plan.totalTravelMinutes||0}분</div>
          <div class="course-desc">${plan.explain || ''}</div>
        `;
                (plan.steps||[]).forEach(st => box.appendChild(renderCard(st.role, st)));
                cards.appendChild(box);
            });
            sum.textContent = `총 예상 이동시간(최적 코스 기준) · 약 ${plans[0].totalTravelMinutes||0}분`;
        }else{
            sum.textContent = '추천 코스를 찾지 못했습니다.';
        }

        window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
    }

    function renderCard(role, s){
        const el = document.createElement('div');
        el.className = 'card';
        const rating = (s.rating!=null) ? Number(s.rating) : null;
        const ratingTxt = (rating!=null) ? `평점 ${rating.toFixed ? rating.toFixed(1) : rating} (${s.ratingCount||0})` : '';
        const name = s.name ?? '?';
        const addr = s.address || '';
        const url  = s.externalUrl || s.mapLink || '#';
        el.innerHTML = `
      <div class="icon">${icon(role)}</div>
      <div>
        <div class="title">${name}</div>
        <div class="sub">${addr}</div>
        <div class="stars">${rating!=null ? star(rating) : ''} ${ratingTxt}</div>
      </div>
      <div class="link"><a href="${url}" target="_blank" rel="noopener">카카오 길찾기</a></div>
    `;
        return el;
    }

    /* ---------------- 버튼 ---------------- */
    document.getElementById('goBtn').addEventListener('click', async ()=>{
        clearErr(); setLoading(true); document.getElementById('result').classList.remove('active');
        try{
            const ideas = await fetchIdeasByAI();
            renderIdeas(ideas);
        }catch(e){
            console.error(e);
            showErr(e.message || '추천 중 오류가 발생했습니다.');
            // 필요하면 여기서 /date/ideas 로 폴백 호출 가능
        }finally{
            setLoading(false);
        }
    });
</script>
</body>
</html>
