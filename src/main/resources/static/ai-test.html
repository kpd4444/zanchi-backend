<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>AI Ask 테스트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{color-scheme:dark light}
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:#0b0b0b;color:#f2f2f2}
        header{position:sticky;top:0;z-index:5;background:rgba(0,0,0,.6);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid rgba(255,255,255,.08)}
        header .bar{max-width:820px;margin:0 auto;display:flex;align-items:center;gap:10px;padding:12px 16px}
        .wrap{max-width:820px;margin:0 auto;padding:16px}
        .row{display:flex;gap:10px}
        input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#141414;color:#fff;outline:none}
        textarea{min-height:160px;white-space:pre-wrap}
        .btn{padding:10px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff;cursor:pointer}
        .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a2a2a;background:#141414}
        .muted{opacity:.75;font-size:13px}
        .ok{color:#2dd4bf}.err{color:#f87171}
        @media (prefers-color-scheme:light){
            body{background:#f7f7f8;color:#111}
            header{background:rgba(255,255,255,.7);border-color:rgba(0,0,0,.06)}
            input,textarea,select{background:#fff;color:#111;border-color:#eaeaea}
            .btn{background:#fafafa;color:#111;border-color:#eaeaea}
            .pill{background:#fff;border-color:#eaeaea}
        }
        code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
    </style>
</head>
<body>
<header>
    <div class="bar">
        <div style="font-weight:800">AI Ask 테스트</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <span id="who" class="muted">토큰 없음</span>
            <button id="paste" class="pill">토큰 붙여넣기</button>
            <button id="clear" class="pill">토큰 삭제</button>
            <a href="login.html?return=ai-test.html" class="pill" style="text-decoration:none;display:grid;place-items:center">로그인</a>
        </div>
    </div>
</header>

<main class="wrap">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
        <label class="muted">엔드포인트</label>
        <input id="endpoint" value="/api/ai/ask" />
        <button id="copyCurl" class="btn">cURL 복사</button>
    </div>

    <div class="row">
        <input id="q" placeholder="질문(예: 인사해줘 / 홍대입구 근처 데이트 코스 추천해줘)" />
        <button id="send" class="btn" style="flex:0 0 140px">보내기</button>
    </div>

    <p id="status" class="muted" style="margin:10px 0 6px"></p>

    <label class="muted">응답</label>
    <textarea id="out" readonly></textarea>
</main>

<script>
    const whoEl = document.getElementById('who');
    const endpointEl = document.getElementById('endpoint');
    const qEl = document.getElementById('q');
    const outEl = document.getElementById('out');
    const statusEl = document.getElementById('status');

    function token(){ return localStorage.getItem('token') || ''; }
    function setStatus(m, ok=false){ statusEl.textContent=m; statusEl.className = ok ? 'muted ok' : 'muted'; }

    async function whoami(){
        const t = token();
        if (!t){ whoEl.textContent = '토큰 없음'; return; }
        const tail = t.slice(-16);
        whoEl.textContent = `토큰 저장됨(…${tail})`;
        // 있으면 간단히 확인(있을 수도, 없을 수도 있는 후보 URL)
        const CAND = ['/api/auth/whoami','/api/me','/api/whoami'];
        for (const u of CAND){
            try{
                const r = await fetch(u,{headers:{Authorization:t}});
                if (r.ok){
                    const j = await r.json().catch(()=> ({}));
                    const name = j.name || j.loginId || j.username || j.user?.name || j.member?.name;
                    if (name){ whoEl.textContent = `${name} (…${tail})`; break; }
                }
            }catch{}
        }
    }

    function asCurl(url, q, t){
        return [
            'curl -G "'+location.origin+url+'"',
            '--data-urlencode "q='+q.replace(/"/g,'\\"')+'"',
            '-H "Authorization: '+t+'"'
        ].join(' \\\n  ');
    }

    document.getElementById('copyCurl').addEventListener('click', ()=>{
        const t = token(); if(!t){ alert('토큰이 없습니다. 로그인 먼저!'); return; }
        const url = endpointEl.value || '/api/ai/ask';
        const q = qEl.value || '';
        const cmd = asCurl(url, q, t);
        navigator.clipboard.writeText(cmd).then(()=> setStatus('cURL 복사됨', true));
    });

    document.getElementById('paste').addEventListener('click', ()=>{
        const raw = prompt('JWT 붙여넣기 (Bearer 포함/미포함 모두 가능)');
        if (raw && raw.trim()){
            const v = raw.trim().startsWith('Bearer ') ? raw.trim() : 'Bearer '+raw.trim();
            localStorage.setItem('token', v);
            whoami();
            setStatus('토큰 저장 완료', true);
        }
    });
    document.getElementById('clear').addEventListener('click', ()=>{
        localStorage.removeItem('token');
        whoami();
        setStatus('토큰 삭제됨', true);
    });

    async function ask(){
        const t = token();
        if (!t){ setStatus('토큰이 없습니다. 로그인 먼저 해주세요.'); return; }
        const url = endpointEl.value || '/api/ai/ask';
        const q = qEl.value.trim();
        if (!q){ setStatus('질문을 입력하세요'); return; }

        outEl.value = '';
        setStatus('요청 중...');

        // 1) GET ?q= 시도
        try{
            const r = await fetch(`${url}?q=${encodeURIComponent(q)}`, { headers:{Authorization:t} });
            if (r.ok){
                const ct = r.headers.get('Content-Type')||'';
                const body = ct.includes('application/json') ? JSON.stringify(await r.json(), null, 2) : await r.text();
                outEl.value = body;
                setStatus(`GET ${r.status} OK`, true);
                return;
            }
            // 405/415면 POST 폴백
            if (r.status===405 || r.status===415){
                throw new Error('fallback');
            } else {
                const txt = await r.text().catch(()=> '');
                outEl.value = txt || '';
                setStatus(`GET ${r.status} 응답`, false);
                return;
            }
        }catch{}

        // 2) POST {q:"..."} 폴백
        try{
            const r = await fetch(url, {
                method:'POST',
                headers:{'Content-Type':'application/json', Authorization:t},
                body: JSON.stringify({ q })
            });
            const ct = r.headers.get('Content-Type')||'';
            const body = ct.includes('application/json') ? JSON.stringify(await r.json(), null, 2) : await r.text();
            outEl.value = body;
            setStatus(`POST ${r.status} ${r.ok?'OK':''}`, r.ok);
        }catch(e){
            outEl.value = (e && e.message) ? e.message : '요청 실패';
            setStatus('요청 실패', false);
        }
    }

    document.getElementById('send').addEventListener('click', ask);
    qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); ask(); } });

    whoami();
</script>
</body>
</html>
