<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .ok { color: green; }
        .fail { color: red; }
        label { display: block; margin: 10px 0 5px; }
        input { padding: 5px; width: 300px; }
        button { padding: 8px 16px; margin-top: 10px; }
        #tokenBox { margin-top: 15px; word-break: break-all; }
    </style>
</head>
<body>
<h1>Login</h1>

<label for="username">Username:</label>
<input id="username" type="text" />

<label for="password">Password:</label>
<input id="password" type="password" />

<button id="loginBtn">로그인</button>

<div id="status"></div>
<div id="tokenBox"></div>

<script>
    const $ = s => document.querySelector(s);

    (function normalizeToken() {
        const old = localStorage.getItem('jwt');
        const cur = localStorage.getItem('token');
        if (!cur && old) {
            const v = old.startsWith('Bearer ') ? old : `Bearer ${old}`;
            localStorage.setItem('token', v);
            localStorage.removeItem('jwt');
        }
        const t = localStorage.getItem('token');
        if (t) {
            $('#tokenBox').textContent = t;
            $('#status').className = 'ok';
            $('#status').textContent = '이미 로그인되어 있습니다.';
        }
    })();

    async function whoami() {
        const t = localStorage.getItem('token');
        const res = await fetch('/api/clips/auth/whoami', { headers: t ? { Authorization: t } : {} });
        if (!res.ok) return { auth: false };
        return res.json();
    }

    $('#loginBtn').addEventListener('click', async () => {
        const username = $('#username').value.trim();
        const password = $('#password').value.trim();
        if (!username || !password) { alert('아이디와 비밀번호를 입력하세요.'); return; }

        try {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ loginId: username, password })
            });

            const text = await res.text();
            const authHeader = res.headers.get('Authorization');

            if (res.ok && authHeader && authHeader.startsWith('Bearer ')) {
                localStorage.setItem('token', authHeader);
                localStorage.removeItem('jwt');
                $('#tokenBox').textContent = authHeader;
                $('#status').className = 'ok';
                $('#status').textContent = `성공 (${res.status}) - ${text}`;
                const me = await whoami();
                if (!me.auth) { alert('인증 확인 실패. 다시 로그인해주세요.'); return; }
                setTimeout(() => location.href = '/clip-feed.html', 400);
            } else {
                $('#status').className = 'fail';
                $('#status').textContent = `실패 (${res.status}) - ${text}`;
            }
        } catch (err) {
            $('#status').className = 'fail';
            $('#status').textContent = '요청 중 오류 발생: ' + err;
        }
    });
</script>
</body>
</html>