<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>이름 변경 테스트</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
        :root{color-scheme:dark light}
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:#0b0b0b;color:#f2f2f2}
        .wrap{max-width:560px;margin:0 auto;padding:16px}
        header{position:sticky;top:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.08);z-index:5}
        header .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
        .title{font-weight:800}
        .card{margin-top:16px;background:#111;border:1px solid #222;border-radius:12px;padding:16px}
        .row{display:flex;gap:10px;align-items:center;margin:10px 0}
        .btn{padding:8px 12px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff;border-radius:10px;font-size:13px;cursor:pointer}
        input[type=text]{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#141414;color:#fff;outline:none}
        .hint{font-size:12px;color:#bdbdbd}
        .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
        .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#222;color:#fff;padding:10px 14px;border-radius:10px;border:1px solid #333;font-size:13px;z-index:9999;display:none}
        @media (prefers-color-scheme:light){
            body{background:#f7f7f8;color:#111}
            header{background:rgba(255,255,255,.7);border-color:rgba(0,0,0,.06)}
            .card{background:#fff;border-color:#ececec}
            .btn{background:#fafafa;color:#111;border-color:#eaeaea}
            input[type=text]{background:#fff;color:#111;border-color:#eaeaea}
        }
    </style>
</head>
<body>
<header>
    <div class="bar wrap">
        <div class="title">이름 변경 테스트</div>
        <button id="reloadBtn" class="btn">현재 이름 새로고침</button>
    </div>
</header>

<main class="wrap">
    <section class="card">
        <div class="row">
            <div>현재 이름:</div>
            <div id="currentName" class="mono">-</div>
        </div>
        <div class="row">
            <input id="nameInput" type="text" placeholder="새 이름을 입력하세요"/>
            <button id="changeBtn" class="btn">이름 변경</button>
        </div>
        <div class="row">
            <button id="randomBtn" class="btn">랜덤 이름 넣기</button>
            <div class="hint">JWT는 <span class="mono">localStorage.token</span> 또는 <span class="mono">localStorage.jwt</span>에서 읽습니다.</div>
        </div>
        <div id="result" class="hint mono"></div>
    </section>
</main>

<div id="toast" class="toast"></div>

<script>
    // ===== Token =====
    function getToken(){
        const t = localStorage.getItem('token') || localStorage.getItem('jwt');
        if(!t) return null;
        return t.startsWith('Bearer ') ? t : `Bearer ${t}`;
    }

    // ===== UI helpers =====
    const $ = s => document.querySelector(s);
    function toast(msg){
        const t = $('#toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(()=> t.style.display='none', 1400);
    }

    // ===== fetch helper (JSON/204 안전) =====
    async function getJson(url, opt = {}){
        const headers = opt.headers ? {...opt.headers} : {};
        const hasBody = opt.body !== undefined && opt.body !== null;
        const isForm = typeof FormData !== 'undefined' && opt.body instanceof FormData;
        if(!headers['Content-Type'] && opt.method && opt.method !== 'GET' && hasBody && !isForm){
            headers['Content-Type'] = 'application/json';
        }
        const tok = getToken();
        if(tok) headers['Authorization'] = tok;

        const res = await fetch(url, {...opt, headers});
        const ct = res.headers.get('Content-Type') || '';
        if(!res.ok){
            const txt = await res.text().catch(()=> '');
            throw new Error(txt || `HTTP ${res.status}`);
        }
        if(res.status === 204) return null;
        if(ct.includes('application/json')) return res.json();
        return res.text().catch(()=> null);
    }

    // ===== API calls =====
    async function loadCurrentName(){
        try{
            const me = await getJson('/api/me/summary'); // { id, name, loginId, ... } 예상
            $('#currentName').textContent = me?.name || me?.loginId || '(이름 없음)';
        }catch(e){
            console.error(e);
            $('#currentName').textContent = '(불러오기 실패)';
            toast((e.message||'').includes('401') ? '로그인이 필요합니다' : '불러오기 실패');
        }
    }

    async function changeMyName(newName){
        const body = { name: newName };
        const res = await getJson('/api/me/name', {
            method: 'PATCH',
            body: JSON.stringify(body)
        });
        return res; // { id, name } 같은 DTO 응답 기대
    }

    // ===== Events =====
    $('#reloadBtn').addEventListener('click', loadCurrentName);

    $('#changeBtn').addEventListener('click', async ()=>{
        const input = $('#nameInput');
        const name = (input.value || '').trim();
        if(!name){ toast('이름을 입력해주세요'); input.focus(); return; }
        try{
            const data = await changeMyName(name);
            $('#result').textContent = JSON.stringify(data, null, 2);
            toast('변경 완료');
            await loadCurrentName();
        }catch(e){
            console.error(e);
            $('#result').textContent = e.message || '에러';
            toast((e.message||'').includes('401') ? '로그인이 필요합니다' : '변경 실패');
        }
    });

    // 엔터키로 제출
    $('#nameInput').addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
            e.preventDefault();
            $('#changeBtn').click();
        }
    });

    // 랜덤 이름 채우기
    $('#randomBtn').addEventListener('click', ()=>{
        const rand = '사용자-' + Math.random().toString(36).slice(2, 7);
        $('#nameInput').value = rand;
    });

    // ===== boot =====
    loadCurrentName();
</script>
</body>
</html>